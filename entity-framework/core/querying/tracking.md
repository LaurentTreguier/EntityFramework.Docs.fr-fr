---
title: Suivi et requêtes de No-Tracking-EF Core
description: Informations sur le suivi et les requêtes sans suivi dans Entity Framework Core
author: smitpatel
ms.date: 11/09/2020
uid: core/querying/tracking
ms.openlocfilehash: b4c059f9a9b726697009589271e007bd1d2afd56
ms.sourcegitcommit: f3512e3a98e685a3ba409c1d0157ce85cc390cf4
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 11/10/2020
ms.locfileid: "94430441"
---
# <a name="tracking-vs-no-tracking-queries"></a><span data-ttu-id="c37c8-103">Suivi et requêtes de No-Tracking</span><span class="sxs-lookup"><span data-stu-id="c37c8-103">Tracking vs. No-Tracking Queries</span></span>

<span data-ttu-id="c37c8-104">Suivi des contrôles de comportement si Entity Framework Core conservera des informations sur une instance d’entité dans son dispositif de suivi des modifications.</span><span class="sxs-lookup"><span data-stu-id="c37c8-104">Tracking behavior controls if Entity Framework Core will keep information about an entity instance in its change tracker.</span></span> <span data-ttu-id="c37c8-105">Si une entité est suivie, toutes les modifications détectées dans l’entité sont rendues persistantes dans la base de données pendant `SaveChanges()`.</span><span class="sxs-lookup"><span data-stu-id="c37c8-105">If an entity is tracked, any changes detected in the entity will be persisted to the database during `SaveChanges()`.</span></span> <span data-ttu-id="c37c8-106">EF Core corrigera également les propriétés de navigation entre les entités dans un résultat de requête de suivi et les entités qui se trouvent dans le dispositif de suivi des modifications.</span><span class="sxs-lookup"><span data-stu-id="c37c8-106">EF Core will also fix up navigation properties between the entities in a tracking query result and the entities that are in the change tracker.</span></span>

> [!NOTE]
> <span data-ttu-id="c37c8-107">Les [types d’entité sans clé](xref:core/modeling/keyless-entity-types) ne sont jamais suivis.</span><span class="sxs-lookup"><span data-stu-id="c37c8-107">[Keyless entity types](xref:core/modeling/keyless-entity-types) are never tracked.</span></span> <span data-ttu-id="c37c8-108">Chaque fois que cet article mentionne des types d’entités, il fait référence aux types d’entité qui ont une clé définie.</span><span class="sxs-lookup"><span data-stu-id="c37c8-108">Wherever this article mentions entity types, it refers to entity types which have a key defined.</span></span>

> [!TIP]  
> <span data-ttu-id="c37c8-109">Vous pouvez afficher cet [exemple](https://github.com/dotnet/EntityFramework.Docs/tree/master/samples/core/Querying/Tracking) sur GitHub.</span><span class="sxs-lookup"><span data-stu-id="c37c8-109">You can view this article's [sample](https://github.com/dotnet/EntityFramework.Docs/tree/master/samples/core/Querying/Tracking) on GitHub.</span></span>

## <a name="tracking-queries"></a><span data-ttu-id="c37c8-110">Requêtes avec suivi</span><span class="sxs-lookup"><span data-stu-id="c37c8-110">Tracking queries</span></span>

<span data-ttu-id="c37c8-111">Par défaut, les requêtes qui retournent des types d’entités ont le suivi activé.</span><span class="sxs-lookup"><span data-stu-id="c37c8-111">By default, queries that return entity types are tracking.</span></span> <span data-ttu-id="c37c8-112">Cela signifie que vous pouvez apporter des modifications à ces instances d’entité et faire en sorte que ces modifications soient rendues persistantes par `SaveChanges()` .</span><span class="sxs-lookup"><span data-stu-id="c37c8-112">Which means you can make changes to those entity instances and have those changes persisted by `SaveChanges()`.</span></span> <span data-ttu-id="c37c8-113">Dans l’exemple suivant, la modification de l’évaluation des blogs sera détectée et rendue persistante dans la base de données pendant `SaveChanges()`.</span><span class="sxs-lookup"><span data-stu-id="c37c8-113">In the following example, the change to the blogs rating will be detected and persisted to the database during `SaveChanges()`.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#Tracking)]

<span data-ttu-id="c37c8-114">Lorsque les résultats sont retournés dans une requête de suivi, EF Core vérifie si l’entité est déjà dans le contexte.</span><span class="sxs-lookup"><span data-stu-id="c37c8-114">When the results are returned in a tracking query, EF Core will check if the entity is already in the context.</span></span> <span data-ttu-id="c37c8-115">Si EF Core trouve une entité existante, la même instance est retournée.</span><span class="sxs-lookup"><span data-stu-id="c37c8-115">If EF Core finds an existing entity, then the same instance is returned.</span></span> <span data-ttu-id="c37c8-116">EF Core ne remplacera pas les valeurs actuelles et d’origine des propriétés de l’entité dans l’entrée avec les valeurs de la base de données.</span><span class="sxs-lookup"><span data-stu-id="c37c8-116">EF Core won't overwrite current and original values of the entity's properties in the entry with the database values.</span></span> <span data-ttu-id="c37c8-117">Si l’entité est introuvable dans le contexte, EF Core crée une nouvelle instance d’entité et l’attache au contexte.</span><span class="sxs-lookup"><span data-stu-id="c37c8-117">If the entity isn't found in the context, then EF Core will create new entity instance and attach it to the context.</span></span> <span data-ttu-id="c37c8-118">Les résultats de la requête ne contiennent pas d’entité, qui est ajoutée au contexte mais pas encore enregistrée dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="c37c8-118">Query results don't contain any entity, which is added to the context but not yet saved to the database.</span></span>

## <a name="no-tracking-queries"></a><span data-ttu-id="c37c8-119">Pas de suivi des requêtes</span><span class="sxs-lookup"><span data-stu-id="c37c8-119">No-tracking queries</span></span>

<span data-ttu-id="c37c8-120">Les requêtes sans suivi sont utiles lorsque les résultats sont utilisés dans un scénario en lecture seule.</span><span class="sxs-lookup"><span data-stu-id="c37c8-120">No tracking queries are useful when the results are used in a read-only scenario.</span></span> <span data-ttu-id="c37c8-121">Elles sont plus rapides à exécuter, car il n’est pas nécessaire de configurer les informations de suivi des modifications.</span><span class="sxs-lookup"><span data-stu-id="c37c8-121">They're quicker to execute because there's no need to set up the change tracking information.</span></span> <span data-ttu-id="c37c8-122">Si vous n’avez pas besoin de mettre à jour les entités récupérées de la base de données, une requête de non-suivi doit être utilisée.</span><span class="sxs-lookup"><span data-stu-id="c37c8-122">If you don't need to update the entities retrieved from the database, then a no-tracking query should be used.</span></span> <span data-ttu-id="c37c8-123">Vous pouvez permuter une requête individuelle pour qu’elle soit sans suivi.</span><span class="sxs-lookup"><span data-stu-id="c37c8-123">You can swap an individual query to be no-tracking.</span></span> <span data-ttu-id="c37c8-124">Aucune requête de suivi ne vous donnera également des résultats en fonction de ce qui se trouve dans la base de données, en ce qui concerne les modifications locales ou les entités ajoutées.</span><span class="sxs-lookup"><span data-stu-id="c37c8-124">No tracking query will also give you results based on what is in the database disregarding any local changes or added entities.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#NoTracking)]

<span data-ttu-id="c37c8-125">Vous pouvez également modifier le comportement de suivi par défaut au niveau de l’instance du contexte :</span><span class="sxs-lookup"><span data-stu-id="c37c8-125">You can also change the default tracking behavior at the context instance level:</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#ContextDefaultTrackingBehavior)]

## <a name="identity-resolution"></a><span data-ttu-id="c37c8-126">Résolution de l'identité</span><span class="sxs-lookup"><span data-stu-id="c37c8-126">Identity resolution</span></span>

<span data-ttu-id="c37c8-127">Dans la mesure où une requête de suivi utilise le suivi des modifications, EF Core effectue la résolution d’identité dans une requête de suivi.</span><span class="sxs-lookup"><span data-stu-id="c37c8-127">Since a tracking query uses the change tracker, EF Core will do identity resolution in a tracking query.</span></span> <span data-ttu-id="c37c8-128">Lors de la matérialisation d’une entité, EF Core retourne la même instance d’entité à partir du dispositif de suivi des modifications si elle fait déjà l’objet d’un suivi.</span><span class="sxs-lookup"><span data-stu-id="c37c8-128">When materializing an entity, EF Core will return the same entity instance from the change tracker if it's already being tracked.</span></span> <span data-ttu-id="c37c8-129">Si le résultat contient plusieurs fois la même entité, vous obtenez la même instance pour chaque occurrence.</span><span class="sxs-lookup"><span data-stu-id="c37c8-129">If the result contains same entity multiple times, you get back same instance for each occurrence.</span></span> <span data-ttu-id="c37c8-130">Les requêtes de non-suivi n’utilisent pas le dispositif de suivi des modifications et n’effectuent pas de résolution d’identité.</span><span class="sxs-lookup"><span data-stu-id="c37c8-130">No-tracking queries don't use the change tracker and don't do identity resolution.</span></span> <span data-ttu-id="c37c8-131">Ainsi, vous obtenez une nouvelle instance de l’entité même lorsque la même entité est contenue plusieurs fois dans le résultat.</span><span class="sxs-lookup"><span data-stu-id="c37c8-131">So you get back new instance of entity even when the same entity is contained in the result multiple times.</span></span> <span data-ttu-id="c37c8-132">Ce comportement est différent dans les versions antérieures à EF Core 3,0, consultez [versions précédentes](#previous-versions).</span><span class="sxs-lookup"><span data-stu-id="c37c8-132">This behavior was different in versions before EF Core 3.0, see [previous versions](#previous-versions).</span></span>

<span data-ttu-id="c37c8-133">À compter de EF Core 5,0, vous pouvez combiner les deux comportements ci-dessus dans la même requête.</span><span class="sxs-lookup"><span data-stu-id="c37c8-133">Starting with EF Core 5.0, you can combine both of the above behaviors in same query.</span></span> <span data-ttu-id="c37c8-134">Autrement dit, vous pouvez avoir une requête aucune suivi, ce qui entraîne la résolution de l’identité dans les résultats.</span><span class="sxs-lookup"><span data-stu-id="c37c8-134">That is, you can have a no tracking query, which will do identity resolution in the results.</span></span> <span data-ttu-id="c37c8-135">Tout comme l' `AsNoTracking()` opérateur interrogeable, nous avons ajouté un autre opérateur `AsNoTrackingWithIdentityResolution()` .</span><span class="sxs-lookup"><span data-stu-id="c37c8-135">Just like `AsNoTracking()` queryable operator, we've added another operator `AsNoTrackingWithIdentityResolution()`.</span></span> <span data-ttu-id="c37c8-136">Une entrée associée est également ajoutée dans <xref:Microsoft.EntityFrameworkCore.QueryTrackingBehavior> enum.</span><span class="sxs-lookup"><span data-stu-id="c37c8-136">There's also associated entry added in <xref:Microsoft.EntityFrameworkCore.QueryTrackingBehavior> enum.</span></span> <span data-ttu-id="c37c8-137">Quand vous configurez la requête pour qu’elle utilise la résolution d’identité sans suivi, nous utilisons un dispositif de suivi des modifications autonome en arrière-plan lors de la génération des résultats de la requête afin que chaque instance ne soit matérialisée qu’une seule fois.</span><span class="sxs-lookup"><span data-stu-id="c37c8-137">When you configure the query to use identity resolution with no tracking, we use a stand-alone change tracker in the background when generating query results so each instance is materialized only once.</span></span> <span data-ttu-id="c37c8-138">Étant donné que ce dispositif de suivi des modifications est différent de celui du contexte, les résultats ne sont pas suivis par le contexte.</span><span class="sxs-lookup"><span data-stu-id="c37c8-138">Since this change tracker is different from the one in the context, the results are not tracked by the context.</span></span> <span data-ttu-id="c37c8-139">Une fois la requête entièrement énumérée, le dispositif de suivi des modifications est hors de portée et récupéré par le garbage collector en fonction des besoins.</span><span class="sxs-lookup"><span data-stu-id="c37c8-139">After the query is enumerated fully, the change tracker goes out of scope and garbage collected as required.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#NoTrackingWithIdentityResolution)]

## <a name="tracking-and-custom-projections"></a><span data-ttu-id="c37c8-140">Suivi et projections personnalisées</span><span class="sxs-lookup"><span data-stu-id="c37c8-140">Tracking and custom projections</span></span>

<span data-ttu-id="c37c8-141">Même si le type de résultat de la requête n’est pas un type d’entité, EF Core effectue toujours le suivi des types d’entité contenus dans le résultat par défaut.</span><span class="sxs-lookup"><span data-stu-id="c37c8-141">Even if the result type of the query isn't an entity type, EF Core will still track entity types contained in the result by default.</span></span> <span data-ttu-id="c37c8-142">Dans la requête suivante, qui retourne un type anonyme, les instances de `Blog` dans le jeu de résultats sont suivies.</span><span class="sxs-lookup"><span data-stu-id="c37c8-142">In the following query, which returns an anonymous type, the instances of `Blog` in the result set will be tracked.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#CustomProjection1)]

<span data-ttu-id="c37c8-143">Si le jeu de résultats contient des types d’entités provenant de la composition LINQ, EF Core les suit.</span><span class="sxs-lookup"><span data-stu-id="c37c8-143">If the result set contains entity types coming out from LINQ composition, EF Core will track them.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#CustomProjection2)]

<span data-ttu-id="c37c8-144">Si le jeu de résultats ne contient aucun type d’entité, aucun suivi n’est effectué.</span><span class="sxs-lookup"><span data-stu-id="c37c8-144">If the result set doesn't contain any entity types, then no tracking is done.</span></span> <span data-ttu-id="c37c8-145">Dans la requête suivante, nous retournons un type anonyme avec certaines des valeurs de l’entité (mais aucune instance du type d’entité réel).</span><span class="sxs-lookup"><span data-stu-id="c37c8-145">In the following query, we return an anonymous type with some of the values from the entity (but no instances of the actual entity type).</span></span> <span data-ttu-id="c37c8-146">Aucune entité suivie n’est en provenance de la requête.</span><span class="sxs-lookup"><span data-stu-id="c37c8-146">There are no tracked entities coming out of the query.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#CustomProjection3)]

 <span data-ttu-id="c37c8-147">EF Core prend en charge l’évaluation du client dans la projection de niveau supérieur.</span><span class="sxs-lookup"><span data-stu-id="c37c8-147">EF Core supports doing client evaluation in the top-level projection.</span></span> <span data-ttu-id="c37c8-148">Si EF Core matérialise une instance d’entité pour l’évaluation du client, elle est suivie.</span><span class="sxs-lookup"><span data-stu-id="c37c8-148">If EF Core materializes an entity instance for client evaluation, it will be tracked.</span></span> <span data-ttu-id="c37c8-149">Ici, puisque nous passons des `blog` entités à la méthode cliente `StandardizeURL` , EF Core effectuera le suivi des instances de blog.</span><span class="sxs-lookup"><span data-stu-id="c37c8-149">Here, since we're passing `blog` entities to the client method `StandardizeURL`, EF Core will track the blog instances too.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#ClientProjection)]

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#ClientMethod)]

<span data-ttu-id="c37c8-150">EF Core n’effectue pas le suivi des instances d’entité keymoins contenues dans le résultat.</span><span class="sxs-lookup"><span data-stu-id="c37c8-150">EF Core doesn't track the keyless entity instances contained in the result.</span></span> <span data-ttu-id="c37c8-151">Mais EF Core effectue le suivi de toutes les autres instances de types d’entité avec la clé conformément aux règles ci-dessus.</span><span class="sxs-lookup"><span data-stu-id="c37c8-151">But EF Core tracks all the other instances of entity types with key according to rules above.</span></span>

<span data-ttu-id="c37c8-152">Certaines des règles ci-dessus ont fonctionné différemment avant EF Core 3,0.</span><span class="sxs-lookup"><span data-stu-id="c37c8-152">Some of the above rules worked differently before EF Core 3.0.</span></span> <span data-ttu-id="c37c8-153">Pour plus d’informations, consultez [versions précédentes](#previous-versions).</span><span class="sxs-lookup"><span data-stu-id="c37c8-153">For more information, see [previous versions](#previous-versions).</span></span>

## <a name="previous-versions"></a><span data-ttu-id="c37c8-154">Versions précédentes</span><span class="sxs-lookup"><span data-stu-id="c37c8-154">Previous versions</span></span>

<span data-ttu-id="c37c8-155">Avant la version 3,0, les EF Core présentaient certaines différences quant à la façon dont le suivi a été effectué.</span><span class="sxs-lookup"><span data-stu-id="c37c8-155">Before version 3.0, EF Core had some differences in how tracking was done.</span></span> <span data-ttu-id="c37c8-156">Les différences notables sont les suivantes :</span><span class="sxs-lookup"><span data-stu-id="c37c8-156">Notable differences are as follows:</span></span>

- <span data-ttu-id="c37c8-157">Comme expliqué dans la page [évaluation des clients vs Server](xref:core/querying/client-eval) , EF Core évaluation du client prise en charge dans n’importe quelle partie de la requête avant la version 3,0.</span><span class="sxs-lookup"><span data-stu-id="c37c8-157">As explained in [Client vs Server Evaluation](xref:core/querying/client-eval) page, EF Core supported client evaluation in any part of the query before version 3.0.</span></span> <span data-ttu-id="c37c8-158">L’évaluation du client a provoqué la matérialisation des entités, ce qui n’a pas fait partie du résultat.</span><span class="sxs-lookup"><span data-stu-id="c37c8-158">Client evaluation caused materialization of entities, which weren't part of the result.</span></span> <span data-ttu-id="c37c8-159">Par conséquent, EF Core analysé le résultat pour détecter les éléments à suivre. Cette conception présentait certaines différences, comme suit :</span><span class="sxs-lookup"><span data-stu-id="c37c8-159">So EF Core analyzed the result to detect what to track. This design had certain differences as follows:</span></span>
  - <span data-ttu-id="c37c8-160">L’évaluation du client dans la projection, qui provoquait la matérialisation mais n’a pas retourné l’instance d’entité matérialisée n’a pas été suivie.</span><span class="sxs-lookup"><span data-stu-id="c37c8-160">Client evaluation in the projection, which caused materialization but didn't return the materialized entity instance wasn't tracked.</span></span> <span data-ttu-id="c37c8-161">L’exemple suivant n’a pas effectué le suivi des `blog` entités.</span><span class="sxs-lookup"><span data-stu-id="c37c8-161">The following example didn't track `blog` entities.</span></span>
    [!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#ClientProjection)]

  - <span data-ttu-id="c37c8-162">Dans certains cas, EF Core n’avez pas suivi les objets en provenance de la composition LINQ.</span><span class="sxs-lookup"><span data-stu-id="c37c8-162">EF Core didn't track the objects coming out of LINQ composition in certain cases.</span></span> <span data-ttu-id="c37c8-163">L’exemple suivant n’a pas été suivi `Post` .</span><span class="sxs-lookup"><span data-stu-id="c37c8-163">The following example didn't track `Post`.</span></span>
    [!code-csharp[Main](../../../samples/core/Querying/Tracking/Program.cs#CustomProjection2)]

- <span data-ttu-id="c37c8-164">Chaque fois que les résultats de la requête contiennent des types d’entité sans clé, l’ensemble de la requête a été rendu non suivi.</span><span class="sxs-lookup"><span data-stu-id="c37c8-164">Whenever query results contained keyless entity types, the whole query was made non-tracking.</span></span> <span data-ttu-id="c37c8-165">Cela signifie que les types d’entité avec des clés, qui sont dans le résultat n’ont pas été suivis.</span><span class="sxs-lookup"><span data-stu-id="c37c8-165">That means that entity types with keys, which are in result weren't being tracked either.</span></span>
- <span data-ttu-id="c37c8-166">EF Core a fait la résolution d’identité dans une requête de non-suivi.</span><span class="sxs-lookup"><span data-stu-id="c37c8-166">EF Core did identity resolution in no-tracking query.</span></span> <span data-ttu-id="c37c8-167">Elle utilisait des références faibles pour effectuer le suivi des entités qui avaient déjà été retournées.</span><span class="sxs-lookup"><span data-stu-id="c37c8-167">It used weak references to keep track of entities that had already been returned.</span></span> <span data-ttu-id="c37c8-168">Par conséquent, si un jeu de résultats contenait la même entité plusieurs fois, vous obtiendriez la même instance pour chaque occurrence.</span><span class="sxs-lookup"><span data-stu-id="c37c8-168">So if a result set contained the same entity multiples times, you would get the same instance for each occurrence.</span></span> <span data-ttu-id="c37c8-169">Toutefois, si un résultat précédent avec la même identité est hors de portée et qu’il a été récupéré par le garbage collector, EF Core retourné une nouvelle instance.</span><span class="sxs-lookup"><span data-stu-id="c37c8-169">Though if a previous result with the same identity went out of scope and got garbage collected, EF Core returned a new instance.</span></span>
