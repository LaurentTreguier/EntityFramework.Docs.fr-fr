---
title: Client et évaluation du serveur-EF Core
author: smitpatel
ms.date: 10/03/2019
ms.assetid: 8b6697cc-7067-4dc2-8007-85d80503d123
uid: core/querying/client-eval
ms.openlocfilehash: 429fec2d2da6eb8910ac20531455ec8183096ec6
ms.sourcegitcommit: ebfd3382fc583bc90f0da58e63d6e3382b30aa22
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 06/25/2020
ms.locfileid: "85370420"
---
# <a name="client-vs-server-evaluation"></a><span data-ttu-id="a826f-102">Comparaison entre client et serveur</span><span class="sxs-lookup"><span data-stu-id="a826f-102">Client vs. Server Evaluation</span></span>

<span data-ttu-id="a826f-103">En règle générale, Entity Framework Core tente d’évaluer autant que possible une requête sur le serveur.</span><span class="sxs-lookup"><span data-stu-id="a826f-103">As a general rule, Entity Framework Core attempts to evaluate a query on the server as much as possible.</span></span> <span data-ttu-id="a826f-104">EF Core convertit des parties de la requête en paramètres, qu’elle peut évaluer côté client.</span><span class="sxs-lookup"><span data-stu-id="a826f-104">EF Core converts parts of the query into parameters, which it can evaluate on the client side.</span></span> <span data-ttu-id="a826f-105">Le reste de la requête (avec les paramètres générés) est donné au fournisseur de base de données pour déterminer la requête de base de données équivalente à évaluer sur le serveur.</span><span class="sxs-lookup"><span data-stu-id="a826f-105">The rest of the query (along with the generated parameters) is given to the database provider to determine the equivalent database query to evaluate on the server.</span></span> <span data-ttu-id="a826f-106">EF Core prend en charge l’évaluation partielle du client dans la projection de niveau supérieur (essentiellement, le dernier appel à `Select()` ).</span><span class="sxs-lookup"><span data-stu-id="a826f-106">EF Core supports partial client evaluation in the top-level projection (essentially, the last call to `Select()`).</span></span> <span data-ttu-id="a826f-107">Si la projection de niveau supérieur dans la requête ne peut pas être traduite sur le serveur, EF Core extrait toutes les données requises du serveur et évalue les autres parties de la requête sur le client.</span><span class="sxs-lookup"><span data-stu-id="a826f-107">If the top-level projection in the query can't be translated to the server, EF Core will fetch any required data from the server and evaluate remaining parts of the query on the client.</span></span> <span data-ttu-id="a826f-108">Si EF Core détecte une expression, à un emplacement autre que la projection de niveau supérieur, qui ne peut pas être traduite sur le serveur, elle lève une exception Runtime.</span><span class="sxs-lookup"><span data-stu-id="a826f-108">If EF Core detects an expression, in any place other than the top-level projection, which can't be translated to the server, then it throws a runtime exception.</span></span> <span data-ttu-id="a826f-109">Découvrez [Comment les requêtes fonctionnent](xref:core/querying/how-query-works) pour comprendre comment EF Core détermine ce qui ne peut pas être traduit sur le serveur.</span><span class="sxs-lookup"><span data-stu-id="a826f-109">See [How queries work](xref:core/querying/how-query-works) to understand how EF Core determines what can't be translated to server.</span></span>

> [!NOTE]
> <span data-ttu-id="a826f-110">Avant la version 3,0, Entity Framework Core l’évaluation du client prise en charge n’importe où dans la requête.</span><span class="sxs-lookup"><span data-stu-id="a826f-110">Prior to version 3.0, Entity Framework Core supported client evaluation anywhere in the query.</span></span> <span data-ttu-id="a826f-111">Pour plus d’informations, consultez la [section versions précédentes](#previous-versions).</span><span class="sxs-lookup"><span data-stu-id="a826f-111">For more information, see the [previous versions section](#previous-versions).</span></span>

> [!TIP]
> <span data-ttu-id="a826f-112">Vous pouvez afficher cet [exemple](https://github.com/dotnet/EntityFramework.Docs/tree/master/samples/core/Querying) sur GitHub.</span><span class="sxs-lookup"><span data-stu-id="a826f-112">You can view this article's [sample](https://github.com/dotnet/EntityFramework.Docs/tree/master/samples/core/Querying) on GitHub.</span></span>

## <a name="client-evaluation-in-the-top-level-projection"></a><span data-ttu-id="a826f-113">Évaluation du client dans la projection de niveau supérieur</span><span class="sxs-lookup"><span data-stu-id="a826f-113">Client evaluation in the top-level projection</span></span>

<span data-ttu-id="a826f-114">Dans l’exemple suivant, une méthode d’assistance est utilisée pour normaliser les URL des blogs, qui sont retournées à partir d’une base de données SQL Server.</span><span class="sxs-lookup"><span data-stu-id="a826f-114">In the following example, a helper method is used to standardize URLs for blogs, which are returned from a SQL Server database.</span></span> <span data-ttu-id="a826f-115">Étant donné que le fournisseur de SQL Server n’a aucune idée de la façon dont cette méthode est implémentée, il n’est pas possible de la traduire en SQL.</span><span class="sxs-lookup"><span data-stu-id="a826f-115">Since the SQL Server provider has no insight into how this method is implemented, it isn't possible to translate it into SQL.</span></span> <span data-ttu-id="a826f-116">Tous les autres aspects de la requête sont évalués dans la base de données, mais le passage du retourné `URL` via cette méthode s’effectue sur le client.</span><span class="sxs-lookup"><span data-stu-id="a826f-116">All other aspects of the query are evaluated in the database, but passing the returned `URL` through this method is done on the client.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/ClientEval/Sample.cs#ClientProjection)]

[!code-csharp[Main](../../../samples/core/Querying/ClientEval/Sample.cs#ClientMethod)]

## <a name="unsupported-client-evaluation"></a><span data-ttu-id="a826f-117">Évaluation du client non prise en charge</span><span class="sxs-lookup"><span data-stu-id="a826f-117">Unsupported client evaluation</span></span>

<span data-ttu-id="a826f-118">Si l’évaluation du client est utile, elle peut entraîner des performances médiocres.</span><span class="sxs-lookup"><span data-stu-id="a826f-118">While client evaluation is useful, it can result in poor performance sometimes.</span></span> <span data-ttu-id="a826f-119">Considérez la requête suivante, dans laquelle la méthode d’assistance est désormais utilisée dans un filtre Where.</span><span class="sxs-lookup"><span data-stu-id="a826f-119">Consider the following query, in which the helper method is now used in a where filter.</span></span> <span data-ttu-id="a826f-120">Étant donné que le filtre ne peut pas être appliqué dans la base de données, toutes les données doivent être extraites en mémoire pour appliquer le filtre sur le client.</span><span class="sxs-lookup"><span data-stu-id="a826f-120">Because the filter can't be applied in the database, all the data needs to be pulled into memory to apply the filter on the client.</span></span> <span data-ttu-id="a826f-121">En fonction du filtre et de la quantité de données sur le serveur, l’évaluation du client peut entraîner des performances médiocres.</span><span class="sxs-lookup"><span data-stu-id="a826f-121">Based on the filter and the amount of data on the server, client evaluation could result in poor performance.</span></span> <span data-ttu-id="a826f-122">Ainsi Entity Framework Core bloque cette évaluation du client et lève une exception d’exécution.</span><span class="sxs-lookup"><span data-stu-id="a826f-122">So Entity Framework Core blocks such client evaluation and throws a runtime exception.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/ClientEval/Sample.cs#ClientWhere)]

## <a name="explicit-client-evaluation"></a><span data-ttu-id="a826f-123">Évaluation explicite du client</span><span class="sxs-lookup"><span data-stu-id="a826f-123">Explicit client evaluation</span></span>

<span data-ttu-id="a826f-124">Vous devrez peut-être forcer l’évaluation du client explicitement dans certains cas, comme suit :</span><span class="sxs-lookup"><span data-stu-id="a826f-124">You may need to force into client evaluation explicitly in certain cases like following</span></span>

- <span data-ttu-id="a826f-125">La quantité de données est faible, de sorte que l’évaluation sur le client n’entraîne pas une baisse considérable des performances.</span><span class="sxs-lookup"><span data-stu-id="a826f-125">The amount of data is small so that evaluating on the client doesn't incur a huge performance penalty.</span></span>
- <span data-ttu-id="a826f-126">L’opérateur LINQ utilisé n’a pas de traduction côté serveur.</span><span class="sxs-lookup"><span data-stu-id="a826f-126">The LINQ operator being used has no server-side translation.</span></span>

<span data-ttu-id="a826f-127">Dans ce cas, vous pouvez choisir explicitement l’évaluation du client en appelant des méthodes telles que `AsEnumerable` ou `ToList` ( `AsAsyncEnumerable` ou `ToListAsync` pour Async).</span><span class="sxs-lookup"><span data-stu-id="a826f-127">In such cases, you can explicitly opt into client evaluation by calling methods like `AsEnumerable` or `ToList` (`AsAsyncEnumerable` or `ToListAsync` for async).</span></span> <span data-ttu-id="a826f-128">En utilisant `AsEnumerable` , vous transmettrez les résultats en continu, mais l’utilisation de `ToList` entraînerait une mise en mémoire tampon en créant une liste, ce qui prend également davantage de mémoire.</span><span class="sxs-lookup"><span data-stu-id="a826f-128">By using `AsEnumerable` you would be streaming the results, but using `ToList` would cause buffering by creating a list, which also takes additional memory.</span></span> <span data-ttu-id="a826f-129">Toutefois, si vous énumérez plusieurs fois, le stockage des résultats dans une liste est plus utile, car il n’existe qu’une seule requête dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="a826f-129">Though if you're enumerating multiple times, then storing results in a list helps more since there's only one query to the database.</span></span> <span data-ttu-id="a826f-130">En fonction de l’utilisation particulière, vous devez déterminer la méthode qui est plus utile pour le cas.</span><span class="sxs-lookup"><span data-stu-id="a826f-130">Depending on the particular usage, you should evaluate which method is more useful for the case.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/ClientEval/Sample.cs#ExplicitClientEval)]

## <a name="potential-memory-leak-in-client-evaluation"></a><span data-ttu-id="a826f-131">Fuite de mémoire potentielle dans l’évaluation du client</span><span class="sxs-lookup"><span data-stu-id="a826f-131">Potential memory leak in client evaluation</span></span>

<span data-ttu-id="a826f-132">Étant donné que la traduction et la compilation des requêtes sont coûteuses, EF Core met en cache le plan de requête compilé.</span><span class="sxs-lookup"><span data-stu-id="a826f-132">Since query translation and compilation are expensive, EF Core caches the compiled query plan.</span></span> <span data-ttu-id="a826f-133">Le délégué mis en cache peut utiliser le code client lors de l’évaluation du client de la projection de niveau supérieur.</span><span class="sxs-lookup"><span data-stu-id="a826f-133">The cached delegate may use client code while doing client evaluation of top-level projection.</span></span> <span data-ttu-id="a826f-134">EF Core génère des paramètres pour les parties évaluées par le client de l’arborescence et réutilise le plan de requête en remplaçant les valeurs des paramètres.</span><span class="sxs-lookup"><span data-stu-id="a826f-134">EF Core generates parameters for the client-evaluated parts of the tree and reuses the query plan by replacing the parameter values.</span></span> <span data-ttu-id="a826f-135">Toutefois, certaines constantes de l’arborescence de l’expression ne peuvent pas être converties en paramètres.</span><span class="sxs-lookup"><span data-stu-id="a826f-135">But certain constants in the expression tree can't be converted into parameters.</span></span> <span data-ttu-id="a826f-136">Si le délégué mis en cache contient des constantes, ces objets ne peuvent pas être récupérés par le garbage collector, car ils sont toujours référencés.</span><span class="sxs-lookup"><span data-stu-id="a826f-136">If the cached delegate contains such constants, then those objects can't be garbage collected since they're still being referenced.</span></span> <span data-ttu-id="a826f-137">Si un tel objet contient un DbContext ou d’autres services qu’il contient, cela peut entraîner une augmentation de l’utilisation de la mémoire de l’application au fil du temps.</span><span class="sxs-lookup"><span data-stu-id="a826f-137">If such an object contains a DbContext or other services in it, then it could cause the memory usage of the app to grow over time.</span></span> <span data-ttu-id="a826f-138">Ce comportement est généralement le signe d’une fuite de mémoire.</span><span class="sxs-lookup"><span data-stu-id="a826f-138">This behavior is generally a sign of a memory leak.</span></span> <span data-ttu-id="a826f-139">EF Core lève une exception chaque fois qu’il s’agit d’une constante d’un type qui ne peut pas être mappé à l’aide du fournisseur de base de données actuel.</span><span class="sxs-lookup"><span data-stu-id="a826f-139">EF Core throws an exception whenever it comes across constants of a type that can't be mapped using current database provider.</span></span> <span data-ttu-id="a826f-140">Les causes courantes et leurs solutions sont les suivantes :</span><span class="sxs-lookup"><span data-stu-id="a826f-140">Common causes and their solutions are as follows:</span></span>

- <span data-ttu-id="a826f-141">**Utilisation d’une méthode d’instance**: lors de l’utilisation de méthodes d’instance dans une projection cliente, l’arborescence de l’expression contient une constante de l’instance.</span><span class="sxs-lookup"><span data-stu-id="a826f-141">**Using an instance method**: When using instance methods in a client projection, the expression tree contains a constant of the instance.</span></span> <span data-ttu-id="a826f-142">Si votre méthode n’utilise pas de données de l’instance, envisagez de rendre la méthode statique.</span><span class="sxs-lookup"><span data-stu-id="a826f-142">If your method doesn't use any data from the instance, consider making the method static.</span></span> <span data-ttu-id="a826f-143">Si vous avez besoin de données d’instance dans le corps de la méthode, transmettez les données spécifiques en tant qu’argument à la méthode.</span><span class="sxs-lookup"><span data-stu-id="a826f-143">If you need instance data in the method body, then pass the specific data as an argument to the method.</span></span>
- <span data-ttu-id="a826f-144">**Passage d’arguments de constante à la méthode**: ce cas se produit généralement à l’aide `this` de dans un argument de la méthode cliente.</span><span class="sxs-lookup"><span data-stu-id="a826f-144">**Passing constant arguments to method**: This case arises generally by using `this` in an argument to client method.</span></span> <span data-ttu-id="a826f-145">Envisagez de fractionner l’argument dans en plusieurs arguments scalaires, qui peuvent être mappés par le fournisseur de base de données.</span><span class="sxs-lookup"><span data-stu-id="a826f-145">Consider splitting the argument in to multiple scalar arguments, which can be mapped by the database provider.</span></span>
- <span data-ttu-id="a826f-146">**Autres constantes**: si une constante est parvenue dans un autre cas, vous pouvez évaluer si la constante est nécessaire dans le traitement.</span><span class="sxs-lookup"><span data-stu-id="a826f-146">**Other constants**: If a constant is come across in any other case, then you can evaluate whether the constant is needed in processing.</span></span> <span data-ttu-id="a826f-147">S’il est nécessaire d’avoir la constante, ou si vous ne pouvez pas utiliser une solution des cas ci-dessus, créez une variable locale pour stocker la valeur et utilisez la variable locale dans la requête.</span><span class="sxs-lookup"><span data-stu-id="a826f-147">If it's necessary to have the constant, or if you can't use a solution from the above cases, then create a local variable to store the value and use local variable in the query.</span></span> <span data-ttu-id="a826f-148">EF Core convertira la variable locale en paramètre.</span><span class="sxs-lookup"><span data-stu-id="a826f-148">EF Core will convert the local variable into a parameter.</span></span>

## <a name="previous-versions"></a><span data-ttu-id="a826f-149">Versions précédentes</span><span class="sxs-lookup"><span data-stu-id="a826f-149">Previous versions</span></span>

<span data-ttu-id="a826f-150">La section suivante s’applique aux versions de EF Core antérieures à 3,0.</span><span class="sxs-lookup"><span data-stu-id="a826f-150">The following section applies to EF Core versions before 3.0.</span></span>

<span data-ttu-id="a826f-151">Les anciennes versions de EF Core prises en charge pour l’évaluation du client dans n’importe quelle partie de la requête, et pas seulement la projection de niveau supérieur.</span><span class="sxs-lookup"><span data-stu-id="a826f-151">Older EF Core versions supported client evaluation in any part of the query--not just the top-level projection.</span></span> <span data-ttu-id="a826f-152">C’est pourquoi les requêtes similaires à une publication sous la section d' [évaluation du client non prise en charge](#unsupported-client-evaluation) fonctionnaient correctement.</span><span class="sxs-lookup"><span data-stu-id="a826f-152">That's why queries similar to one posted under the [Unsupported client evaluation](#unsupported-client-evaluation) section worked correctly.</span></span> <span data-ttu-id="a826f-153">Dans la mesure où ce comportement peut provoquer des problèmes de performances invisibles, EF Core journalisé un avertissement d’évaluation du client.</span><span class="sxs-lookup"><span data-stu-id="a826f-153">Since this behavior could cause unnoticed performance issues, EF Core logged a client evaluation warning.</span></span> <span data-ttu-id="a826f-154">Pour plus d’informations sur l’affichage de la sortie de journalisation, consultez [journalisation](xref:core/miscellaneous/logging).</span><span class="sxs-lookup"><span data-stu-id="a826f-154">For more information on viewing logging output, see [Logging](xref:core/miscellaneous/logging).</span></span>

<span data-ttu-id="a826f-155">Si vous le souhaitez, vous pouvez EF Core modifier le comportement par défaut pour lever une exception ou ne rien faire lors de l’évaluation du client (à l’exception de dans la projection).</span><span class="sxs-lookup"><span data-stu-id="a826f-155">Optionally EF Core allowed you to change the default behavior to either throw an exception or do nothing when doing client evaluation (except for in the projection).</span></span> <span data-ttu-id="a826f-156">Le comportement de levée d’exception le rendrait similaire au comportement dans 3,0.</span><span class="sxs-lookup"><span data-stu-id="a826f-156">The exception throwing behavior would make it similar to the behavior in 3.0.</span></span> <span data-ttu-id="a826f-157">Pour modifier le comportement, vous devez configurer des avertissements lors de la configuration des options de votre contexte, généralement dans `DbContext.OnConfiguring` , ou dans `Startup.cs` si vous utilisez ASP.net core.</span><span class="sxs-lookup"><span data-stu-id="a826f-157">To change the behavior, you need to configure warnings while setting up the options for your context - typically in `DbContext.OnConfiguring`, or in `Startup.cs` if you're using ASP.NET Core.</span></span>

```csharp
protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
{
    optionsBuilder
        .UseSqlServer(@"Server=(localdb)\mssqllocaldb;Database=EFQuerying;Trusted_Connection=True;")
        .ConfigureWarnings(warnings => warnings.Throw(RelationalEventId.QueryClientEvaluationWarning));
}
```
