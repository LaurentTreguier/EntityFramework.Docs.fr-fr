---
title: Diagnostic des performances-EF Core
description: Diagnostic des performances de Entity Framework Core et identification des goulots d’étranglement
author: roji
ms.date: 12/1/2020
uid: core/performance/performance-diagnosis
ms.openlocfilehash: 9416acf3326056ef7a5d732c4bd456dac751167b
ms.sourcegitcommit: 4860d036ea0fb392c28799907bcc924c987d2d7b
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 12/17/2020
ms.locfileid: "97657804"
---
# <a name="performance-diagnosis"></a><span data-ttu-id="26463-103">Diagnostic des performances</span><span class="sxs-lookup"><span data-stu-id="26463-103">Performance Diagnosis</span></span>

<span data-ttu-id="26463-104">Cette section décrit les méthodes permettant de détecter les problèmes de performances dans votre application EF, et une fois qu’une zone problématique a été identifiée, comment les analyser plus en détail pour identifier le problème racine.</span><span class="sxs-lookup"><span data-stu-id="26463-104">This section discusses ways for detecting performance issues in your EF application, and once a problematic area has been identified, how to further analyze them to identify the root problem.</span></span> <span data-ttu-id="26463-105">Il est important de diagnostiquer et d’examiner attentivement les problèmes avant de passer à des conclusions, et de ne pas supposer que la racine du problème se trouve à l’origine du problème.</span><span class="sxs-lookup"><span data-stu-id="26463-105">It's important to carefully diagnose and investigate any problems before jumping to any conclusions, and to avoid assuming where the root of the issue is.</span></span>

## <a name="identifying-slow-database-commands-via-logging"></a><span data-ttu-id="26463-106">Identification des commandes de base de données lentes via la journalisation</span><span class="sxs-lookup"><span data-stu-id="26463-106">Identifying slow database commands via logging</span></span>

<span data-ttu-id="26463-107">À la fin de la journée, EF prépare et exécute des commandes à exécuter sur votre base de données ; avec une base de données relationnelle, cela signifie exécuter des instructions SQL via l’API de base de données ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="26463-107">At the end of the day, EF prepares and executes commands to be executed against your database; with relational database, that means executing SQL statements via the ADO.NET database API.</span></span> <span data-ttu-id="26463-108">Si une requête prend trop de temps (par exemple, en raison de l’absence d’un index), elle peut être détectée en inspectant les journaux d’exécution des commandes et en observant le temps réellement nécessaire.</span><span class="sxs-lookup"><span data-stu-id="26463-108">If a certain query is taking too much time (e.g. because an index is missing), this can be seen discovered by inspecting command execution logs and observing how long they actually take.</span></span>

<span data-ttu-id="26463-109">Avec EF, il est très facile de capturer les durées d’exécution des commandes via la [journalisation simple](xref:core/logging-events-diagnostics/simple-logging) ou [Microsoft. extensions. Logging](xref:core/logging-events-diagnostics/extensions-logging):</span><span class="sxs-lookup"><span data-stu-id="26463-109">EF makes it very easy to capture command execution times, via either [simple logging](xref:core/logging-events-diagnostics/simple-logging) or [Microsoft.Extensions.Logging](xref:core/logging-events-diagnostics/extensions-logging):</span></span>

### <a name="simple-logging"></a>[<span data-ttu-id="26463-110">Journalisation simple</span><span class="sxs-lookup"><span data-stu-id="26463-110">Simple logging</span></span>](#tab/simple-logging)

[!code-csharp[Main](../../../samples/core/Performance/BloggingContext.cs#SimpleLogging)]

### <a name="microsoftextensionslogging"></a>[<span data-ttu-id="26463-111">Microsoft.Extensions.Logging</span><span class="sxs-lookup"><span data-stu-id="26463-111">Microsoft.Extensions.Logging</span></span>](#tab/microsoft-extensions-logging)

[!code-csharp[Main](../../../samples/core/Performance/ExtensionsLoggingContext.cs#ExtensionsLogging)]

***

<span data-ttu-id="26463-112">Lorsque le niveau de journalisation est défini sur `LogLevel.Information` , EF émet un message de journal pour chaque exécution de commande avec le temps écoulé :</span><span class="sxs-lookup"><span data-stu-id="26463-112">When the logging level is set at `LogLevel.Information`, EF emits a log message for each command execution with the time taken:</span></span>

```log
info: 06/12/2020 09:12:36.117 RelationalEventId.CommandExecuted[20101] (Microsoft.EntityFrameworkCore.Database.Command)
      Executed DbCommand (4ms) [Parameters=[], CommandType='Text', CommandTimeout='30']
      SELECT [b].[Id], [b].[Name]
      FROM [Blogs] AS [b]
      WHERE [b].[Name] = N'foo'
```

<span data-ttu-id="26463-113">La commande ci-dessus a pris 4 millisecondes.</span><span class="sxs-lookup"><span data-stu-id="26463-113">The above command took 4 milliseconds.</span></span> <span data-ttu-id="26463-114">Si une certaine commande prend plus que prévu, vous avez trouvé une cause possible d’un problème de performances et vous pouvez maintenant vous concentrer sur la raison pour laquelle elle s’exécute lentement.</span><span class="sxs-lookup"><span data-stu-id="26463-114">If a certain command takes more than expected, you've found a possible culprit for a performance issue, and can now focus on it to understand why it's running slowly.</span></span> <span data-ttu-id="26463-115">La journalisation des commandes peut également révéler des cas où des allers-retours inattendus sont effectués. Cela s’affiche sous la forme de plusieurs commandes dans lesquelles une seule est attendue.</span><span class="sxs-lookup"><span data-stu-id="26463-115">Command logging can also reveal cases where unexpected database roundtrips are being made; this would show up as multiple commands where only one is expected.</span></span>

> [!WARNING]
> <span data-ttu-id="26463-116">Le fait de laisser la journalisation de l’exécution des commandes activée dans votre environnement de production est généralement une mauvaise idée.</span><span class="sxs-lookup"><span data-stu-id="26463-116">Leaving command execution logging enabled in your production environment is usually a bad idea.</span></span> <span data-ttu-id="26463-117">La journalisation elle-même ralentit votre application et peut rapidement créer des fichiers journaux volumineux qui peuvent remplir le disque de votre serveur.</span><span class="sxs-lookup"><span data-stu-id="26463-117">The logging itself slows down your application, and may quickly create huge log files which can fill up your server's disk.</span></span> <span data-ttu-id="26463-118">Il est recommandé de ne garder la connexion que pendant un bref intervalle de temps pour collecter des données, tout en surveillant avec soin votre application, ou en capturant les données de journalisation sur un système de préproduction.</span><span class="sxs-lookup"><span data-stu-id="26463-118">It's recommended to only keep logging on for a short interval of time to gather data - while carefully monitoring your application - or to capture logging data on a pre-production system.</span></span>

## <a name="correlating-database-commands-to-linq-queries"></a><span data-ttu-id="26463-119">Corrélation des commandes de base de données avec les requêtes LINQ</span><span class="sxs-lookup"><span data-stu-id="26463-119">Correlating database commands to LINQ queries</span></span>

<span data-ttu-id="26463-120">L’un des problèmes liés à la journalisation de l’exécution des commandes est qu’il est parfois difficile de mettre en corrélation les requêtes SQL et les requêtes LINQ : les commandes SQL exécutées par EF peuvent paraître très différentes des requêtes LINQ à partir desquelles elles ont été générées.</span><span class="sxs-lookup"><span data-stu-id="26463-120">One problem with command execution logging is that it's sometimes difficult to correlate SQL queries and LINQ queries: the SQL commands executed by EF can look very different from the LINQ queries from which they were generated.</span></span> <span data-ttu-id="26463-121">Pour vous aider dans cette difficulté, vous pouvez utiliser la fonctionnalité de [balises de requête](xref:core/querying/tags) d’EF, qui vous permet d’injecter un petit commentaire d’identification dans la requête SQL :</span><span class="sxs-lookup"><span data-stu-id="26463-121">To help with this difficulty, you may want to use EF's [query tags](xref:core/querying/tags) feature, which allows you to inject a small, identifying comment into the SQL query:</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tags/Program.cs#BasicQueryTag)]

<span data-ttu-id="26463-122">La balise apparaît dans les journaux :</span><span class="sxs-lookup"><span data-stu-id="26463-122">The tag shows up in the logs:</span></span>

```sql
-- This is my spatial query!

SELECT TOP(@__p_1) [p].[Id], [p].[Location]
FROM [People] AS [p]
ORDER BY [p].[Location].STDistance(@__myLocation_0) DESC
```

<span data-ttu-id="26463-123">Il est souvent utile de baliser les requêtes principales d’une application de cette façon, afin de rendre les journaux d’exécution des commandes plus lisibles.</span><span class="sxs-lookup"><span data-stu-id="26463-123">It's often worth tagging the major queries of an application in this way, to make the command execution logs more immediately readable.</span></span>

## <a name="other-interfaces-for-capturing-performance-data"></a><span data-ttu-id="26463-124">Autres interfaces pour la capture des données de performances</span><span class="sxs-lookup"><span data-stu-id="26463-124">Other interfaces for capturing performance data</span></span>

<span data-ttu-id="26463-125">Il existe diverses alternatives à la fonctionnalité de journalisation d’EF pour capturer les durées d’exécution des commandes, ce qui peut être plus puissant.</span><span class="sxs-lookup"><span data-stu-id="26463-125">There are various alternatives to EF's logging feature for capturing command execution times, which may be more powerful.</span></span> <span data-ttu-id="26463-126">Les bases de données sont généralement associées à leurs propres outils de suivi et d’analyse des performances, qui fournissent généralement des informations plus riches et spécifiques à la base de données, au-delà des temps d’exécution simples. l’installation, les fonctionnalités et l’utilisation réelles varient considérablement d’une base de données à l’autre.</span><span class="sxs-lookup"><span data-stu-id="26463-126">Databases typically come with their own tracing and performance analysis tools, which usually provide much richer, database-specific information beyond simple execution times; the actual setup, capabilities and usage vary considerably across databases.</span></span>

<span data-ttu-id="26463-127">Par exemple, [SQL Server Management Studio](/sql/ssms/download-sql-server-management-studio-ssms) est un client puissant qui peut se connecter à votre instance SQL Server et fournir des informations de gestion et de performances précieuses.</span><span class="sxs-lookup"><span data-stu-id="26463-127">For example, [SQL Server Management Studio](/sql/ssms/download-sql-server-management-studio-ssms) is a powerful client that can connect to your SQL Server  instance and provide valuable management and performance information.</span></span> <span data-ttu-id="26463-128">L’objectif de cette section n’est pas d’aborder les détails, mais deux fonctionnalités méritent d’être citées : le [moniteur d’activité](/sql/relational-databases/performance-monitor/open-activity-monitor-sql-server-management-studio), qui fournit un tableau de bord dynamique de l’activité du serveur (y compris les requêtes les plus coûteuses) et la fonctionnalité [événements étendus (XEvent)](/sql/relational-databases/extended-events/quick-start-extended-events-in-sql-server) , qui permet de définir des sessions de capture de données arbitraires qui peuvent être adaptées à vos besoins.</span><span class="sxs-lookup"><span data-stu-id="26463-128">It's beyond the scope of this section to go into the details, but two capabilities worth mentioning are the [Activity Monitor](/sql/relational-databases/performance-monitor/open-activity-monitor-sql-server-management-studio), which provides a live dashboard of server activity (including the most expensive queries), and the [Extended Events (XEvent)](/sql/relational-databases/extended-events/quick-start-extended-events-in-sql-server) feature, which allows defining arbitrary data capture sessions which can be tailored to your exact needs.</span></span> <span data-ttu-id="26463-129">[La documentation SQL Server sur la surveillance](/sql/relational-databases/performance/monitor-and-tune-for-performance) fournit des informations supplémentaires sur ces fonctionnalités, ainsi que sur d’autres.</span><span class="sxs-lookup"><span data-stu-id="26463-129">[The SQL Server documentation on monitoring](/sql/relational-databases/performance/monitor-and-tune-for-performance) provides more information on these features, as well as others.</span></span>

<span data-ttu-id="26463-130">Une autre approche pour la capture des données de performances consiste à collecter les informations émises automatiquement par EF ou le pilote de base de données via l' `DiagnosticSource` interface, puis à analyser ces données ou à les afficher dans un tableau de bord.</span><span class="sxs-lookup"><span data-stu-id="26463-130">Another approach for capturing performance data is to collect information automatically emitted by either EF or the database driver via the `DiagnosticSource` interface, and then analyze that data or display it on a dashboard.</span></span> <span data-ttu-id="26463-131">Si vous utilisez Azure, [Azure application Insights](https://docs.microsoft.com/azure/azure-monitor/learn/tutorial-performance) fournit une surveillance puissante prête à l’emploi, intégrant les performances de la base de données et les temps d’exécution des requêtes dans l’analyse de la vitesse à laquelle vos requêtes Web sont servies.</span><span class="sxs-lookup"><span data-stu-id="26463-131">If you are using Azure, then [Azure Application Insights](https://docs.microsoft.com/azure/azure-monitor/learn/tutorial-performance) provides such powerful monitoring out of the box, integrating database performance and query execution times in the analysis of how quickly your web requests are being served.</span></span> <span data-ttu-id="26463-132">Pour plus d’informations à ce propos, [reApplication Insights didacticiel](/azure/azure-monitor/learn/tutorial-performance)sur les performances et dans la [page Azure SQL Analytics](/azure/azure-monitor/insights/azure-sql).</span><span class="sxs-lookup"><span data-stu-id="26463-132">More information on this is available in the [Application Insights performance tutorial](/azure/azure-monitor/learn/tutorial-performance), and in the [Azure SQL analytics page](/azure/azure-monitor/insights/azure-sql).</span></span>

## <a name="inspecting-query-execution-plans"></a><span data-ttu-id="26463-133">Inspection des plans d’exécution de requête</span><span class="sxs-lookup"><span data-stu-id="26463-133">Inspecting query execution plans</span></span>

<span data-ttu-id="26463-134">Une fois que vous avez identifié une requête problématique qui nécessite une optimisation, l’étape suivante consiste généralement à analyser le *plan d’exécution* de la requête.</span><span class="sxs-lookup"><span data-stu-id="26463-134">Once you've pinpointed a problematic query that requires optimization, the next step is usually analyzing the query's *execution plan*.</span></span> <span data-ttu-id="26463-135">Lorsque les bases de données reçoivent une instruction SQL, elles produisent généralement un plan de la façon dont ce plan doit être exécuté ; Cela nécessite parfois une prise de décision compliquée basée sur les index définis, sur la quantité de données qui existent dans les tables, etc. (par ailleurs, le plan lui-même doit généralement être mis en cache sur le serveur pour des performances optimales).</span><span class="sxs-lookup"><span data-stu-id="26463-135">When databases receive a SQL statement, they typically produce a plan of how that plan is to be executed; this sometimes requires complicated decision-making based on which indexes have been defined, how much data exists in tables, etc. (incidentally, the plan itself should usually be cached at the server for optimal performance).</span></span> <span data-ttu-id="26463-136">En règle générale, les bases de données relationnelles permettent aux utilisateurs de voir le plan de requête, ainsi que les coûts calculés pour les différentes parties de la requête. Cela est très utile pour l’amélioration de vos requêtes.</span><span class="sxs-lookup"><span data-stu-id="26463-136">Relational databases typically provide a way for users to see the query plan, along with calculated costing for different parts of the query; this is invaluable for improving your queries.</span></span>

<span data-ttu-id="26463-137">Pour commencer à utiliser SQL Server, consultez la documentation sur les [plans d’exécution de requête](/sql/relational-databases/performance/execution-plans).</span><span class="sxs-lookup"><span data-stu-id="26463-137">To get started on SQL Server, see the documentation on [query execution plans](/sql/relational-databases/performance/execution-plans).</span></span> <span data-ttu-id="26463-138">Le flux de travail d’analyse classique consiste à utiliser [SQL Server Management Studio](/sql/relational-databases/performance/display-an-actual-execution-plan), à coller le SQL d’une requête lente identifiée à l’aide de l’un des moyens ci-dessus et à [produire un plan d’exécution graphique](/sql/relational-databases/performance/display-an-actual-execution-plan):</span><span class="sxs-lookup"><span data-stu-id="26463-138">The typical analysis workflow would be to use [SQL Server Management Studio](/sql/relational-databases/performance/display-an-actual-execution-plan), pasting the SQL of a slow query identified via one of the means above, and [producing a graphical execution plan](/sql/relational-databases/performance/display-an-actual-execution-plan):</span></span>

![Afficher un plan d’exécution de SQL Server](_static/actualexecplan.png)

<span data-ttu-id="26463-140">Alors que les plans d’exécution peuvent paraître compliqués au début, il est utile de consacrer un peu de temps à les connaître.</span><span class="sxs-lookup"><span data-stu-id="26463-140">While execution plans may seem complicated at first, it's worth spending a bit of time getting familiar with them.</span></span> <span data-ttu-id="26463-141">Il est particulièrement important de noter les coûts associés à chaque nœud du plan et d’identifier la façon dont les index sont utilisés (ou non) dans les différents nœuds.</span><span class="sxs-lookup"><span data-stu-id="26463-141">It's particularly important to note the costs associated with each node of the plan, and to identify how indexes are used (or not) in the various nodes.</span></span>

<span data-ttu-id="26463-142">Bien que les informations ci-dessus soient spécifiques à SQL Server, les autres bases de données fournissent généralement le même type d’outils avec une visualisation similaire.</span><span class="sxs-lookup"><span data-stu-id="26463-142">While the above information is specific to SQL Server, other databases typically provide the same kind of tools with similar visualization.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="26463-143">Les bases de données génèrent parfois différents plans de requête en fonction des données réelles de la base de données.</span><span class="sxs-lookup"><span data-stu-id="26463-143">Databases sometimes generate different query plans depending on actual data in the database.</span></span> <span data-ttu-id="26463-144">Par exemple, si une table contient uniquement quelques lignes, une base de données peut choisir de ne pas utiliser un index sur cette table, mais d’effectuer une analyse de table complète à la place.</span><span class="sxs-lookup"><span data-stu-id="26463-144">For example, if a table contains only a few rows, a database may choose not to use an index on that table, but to perform a full table scan instead.</span></span> <span data-ttu-id="26463-145">Si vous analysez des plans de requête sur une base de données de test, assurez-vous toujours qu’il contient des données similaires à celles de votre système de production.</span><span class="sxs-lookup"><span data-stu-id="26463-145">If analyzing query plans on a test database, always make sure it contains data that is similar to your production system.</span></span>

## <a name="event-counters"></a><span data-ttu-id="26463-146">Compteurs d’événements</span><span class="sxs-lookup"><span data-stu-id="26463-146">Event counters</span></span>

<span data-ttu-id="26463-147">Les sections ci-dessus portent sur l’obtention d’informations sur vos commandes et sur l’exécution de ces commandes dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="26463-147">The above sections focused on how to get information about your commands, and how these commands are executed in the database.</span></span> <span data-ttu-id="26463-148">En outre, EF expose un ensemble de compteurs d' *événements* qui fournissent des informations plus détaillées sur ce qui se passe dans EF lui-même et sur la manière dont votre application l’utilise.</span><span class="sxs-lookup"><span data-stu-id="26463-148">In addition to that, EF exposes a set of *event counters* which provide more lower-level information on what's happening inside EF itself, and how your application is using it.</span></span> <span data-ttu-id="26463-149">Ces compteurs peuvent être très utiles pour diagnostiquer des problèmes de performances spécifiques et des anomalies de performances, telles que des [problèmes de mise en cache des requêtes](xref:core/performance/advanced-performance-topics#dynamically-constructed-queries) qui provoquent une recompilation constante, des fuites de DbContext non commises et d’autres.</span><span class="sxs-lookup"><span data-stu-id="26463-149">These counters can be very useful for diagnosing specific performance issues and performance anomalies, such as [query caching issues](xref:core/performance/advanced-performance-topics#dynamically-constructed-queries) which cause constant recompilation, undisposed DbContext leaks, and others.</span></span>

<span data-ttu-id="26463-150">Pour plus d’informations, consultez la page dédiée sur les [compteurs d’événements d’EF](xref:core/logging-events-diagnostics/event-counters) .</span><span class="sxs-lookup"><span data-stu-id="26463-150">See the dedicated page on [EF's event counters](xref:core/logging-events-diagnostics/event-counters) for more information.</span></span>

## <a name="benchmarking-with-ef-core"></a><span data-ttu-id="26463-151">Évaluation avec EF Core</span><span class="sxs-lookup"><span data-stu-id="26463-151">Benchmarking with EF Core</span></span>

<span data-ttu-id="26463-152">À la fin de la journée, vous devez parfois savoir si une façon particulière d’écrire ou d’exécuter une requête est plus rapide qu’une autre.</span><span class="sxs-lookup"><span data-stu-id="26463-152">At the end of the day, you sometimes need to know whether a particular way of writing or executing a query is faster than another.</span></span> <span data-ttu-id="26463-153">Il est important de ne jamais supposer ou spéculer la réponse, et il est très facile de mettre en place un banc d’essai rapide pour obtenir la réponse.</span><span class="sxs-lookup"><span data-stu-id="26463-153">It's important to never assume or speculate the answer, and it's extremely easy to put together a quick benchmark to get the answer.</span></span> <span data-ttu-id="26463-154">Lors de l’écriture d’un test d’évaluation, il est fortement recommandé d’utiliser la bibliothèque [BenchmarkDotNet](https://benchmarkdotnet.org/index.html) connue, qui gère de nombreux pièges rencontrés par les utilisateurs lors de la tentative d’écriture de leurs propres tests d’évaluation : avez-vous effectué des itérations de préparation ?</span><span class="sxs-lookup"><span data-stu-id="26463-154">When writing benchmarks, it's strongly recommended to use the well-known [BenchmarkDotNet](https://benchmarkdotnet.org/index.html) library, which handles many pitfalls users encounter when trying to write their own benchmarks: have you performed some warmup iterations?</span></span> <span data-ttu-id="26463-155">Combien d’itérations votre évaluation s’exécute-t-elle réellement et pourquoi ?</span><span class="sxs-lookup"><span data-stu-id="26463-155">How many iterations does your benchmark actually run, and why?</span></span> <span data-ttu-id="26463-156">Jetons un coup d’œil à ce à quoi ressemble un point de référence avec EF Core.</span><span class="sxs-lookup"><span data-stu-id="26463-156">Let's take a look at what a benchmark with EF Core looks like.</span></span>

> [!TIP]
> <span data-ttu-id="26463-157">Le projet de test complet pour la source ci-dessous est disponible [ici](https://github.com/dotnet/EntityFramework.Docs/tree/master/samples/core/Benchmarks/AverageBlogRanking.cs).</span><span class="sxs-lookup"><span data-stu-id="26463-157">The full benchmark project for the source below is available [here](https://github.com/dotnet/EntityFramework.Docs/tree/master/samples/core/Benchmarks/AverageBlogRanking.cs).</span></span> <span data-ttu-id="26463-158">Vous êtes encouragé à le copier et à l’utiliser comme modèle pour vos propres tests d’évaluation.</span><span class="sxs-lookup"><span data-stu-id="26463-158">You are encouraged to copy it and use it as a template for your own benchmarks.</span></span>

<span data-ttu-id="26463-159">En guise de scénario de test simple, nous allons comparer les différentes méthodes de calcul du classement moyen de tous les blogs de notre base de données :</span><span class="sxs-lookup"><span data-stu-id="26463-159">As a simple benchmark scenario, let's compare the following different methods of calculating the average ranking of all Blogs in our database:</span></span>

* <span data-ttu-id="26463-160">Chargez toutes les entités, additionnez leurs classements individuels et calculez la moyenne.</span><span class="sxs-lookup"><span data-stu-id="26463-160">Load all entities, sum up their individual rankings, and calculate the average.</span></span>
* <span data-ttu-id="26463-161">Comme ci-dessus, utilisez uniquement une requête de non-suivi.</span><span class="sxs-lookup"><span data-stu-id="26463-161">The same as above, only use a non-tracking query.</span></span> <span data-ttu-id="26463-162">Cela devrait être plus rapide, car la résolution de l’identité n’est pas effectuée et les entités ne sont pas instantanées dans le cadre du suivi des modifications.</span><span class="sxs-lookup"><span data-stu-id="26463-162">This should be faster, since identity resolution isn't performed, and the entities aren't snapshotted for the purposes of change tracking.</span></span>
* <span data-ttu-id="26463-163">Évitez de charger l’ensemble des instances d’entité de blog, en projetant uniquement le classement.</span><span class="sxs-lookup"><span data-stu-id="26463-163">Avoid loading the entire Blog entity instances at all, by projecting out the ranking only.</span></span> <span data-ttu-id="26463-164">Le évite de transférer les autres colonnes inutiles du type d’entité de blog.</span><span class="sxs-lookup"><span data-stu-id="26463-164">The saves us from transferring the other, unneeded columns of the Blog entity type.</span></span>
* <span data-ttu-id="26463-165">Calculez la moyenne dans la base de données en la faisant partie de la requête.</span><span class="sxs-lookup"><span data-stu-id="26463-165">Calculate the average in the database by making it part of the query.</span></span> <span data-ttu-id="26463-166">Cela doit être le moyen le plus rapide, puisque tout est calculé dans la base de données et que seul le résultat est transféré au client.</span><span class="sxs-lookup"><span data-stu-id="26463-166">This should be the fastest way, since everything is calculated in the database and only the result is transferred back to the client.</span></span>

<span data-ttu-id="26463-167">Avec BenchmarkDotNet, vous écrivez le code à évaluer comme une méthode simple, tout comme un test unitaire-et BenchmarkDotNet exécute automatiquement chaque méthode pour un nombre suffisant d’itérations, en mesurant de manière fiable le temps nécessaire et la quantité de mémoire allouée.</span><span class="sxs-lookup"><span data-stu-id="26463-167">With BenchmarkDotNet, you write the code to be benchmarked as a simple method - just like a unit test - and BenchmarkDotNet automatically runs each method for sufficient number of iterations, reliably measuring how long it takes and how much memory is allocated.</span></span> <span data-ttu-id="26463-168">Voici la méthode différente ([le code d’évaluation complet peut être consulté ici](https://github.com/dotnet/EntityFramework.Docs/tree/master/samples/core/Benchmarks/AverageBlogRanking.cs)) :</span><span class="sxs-lookup"><span data-stu-id="26463-168">Here are the different method ([the full benchmark code can be seen here](https://github.com/dotnet/EntityFramework.Docs/tree/master/samples/core/Benchmarks/AverageBlogRanking.cs)):</span></span>

### <a name="load-entities"></a>[<span data-ttu-id="26463-169">Charger des entités</span><span class="sxs-lookup"><span data-stu-id="26463-169">Load entities</span></span>](#tab/load-entities)

[!code-csharp[Main](../../../samples/core/Benchmarks/AverageBlogRanking.cs?name=LoadEntities)]

### <a name="load-entities-no-tracking"></a>[<span data-ttu-id="26463-170">Charger des entités, pas de suivi</span><span class="sxs-lookup"><span data-stu-id="26463-170">Load entities, no tracking</span></span>](#tab/load-entities-no-tracking)

[!code-csharp[Main](../../../samples/core/Benchmarks/AverageBlogRanking.cs?name=LoadEntitiesNoTracking)]

### <a name="project-only-ranking"></a>[<span data-ttu-id="26463-171">Classement du projet uniquement</span><span class="sxs-lookup"><span data-stu-id="26463-171">Project only ranking</span></span>](#tab/project-only-ranking)

[!code-csharp[Main](../../../samples/core/Benchmarks/AverageBlogRanking.cs?name=ProjectOnlyRanking)]

### <a name="calculate-in-database"></a>[<span data-ttu-id="26463-172">Calculer dans la base de données</span><span class="sxs-lookup"><span data-stu-id="26463-172">Calculate in database</span></span>](#tab/calculate-in-database)

[!code-csharp[Main](../../../samples/core/Benchmarks/AverageBlogRanking.cs?name=CalculateInDatabase)]

***

<span data-ttu-id="26463-173">Les résultats sont affichés ci-dessous, tels qu’imprimés par BenchmarkDotNet :</span><span class="sxs-lookup"><span data-stu-id="26463-173">The results are below, as printed by BenchmarkDotNet:</span></span>

|                 <span data-ttu-id="26463-174">Méthode</span><span class="sxs-lookup"><span data-stu-id="26463-174">Method</span></span> |       <span data-ttu-id="26463-175">Moyenne</span><span class="sxs-lookup"><span data-stu-id="26463-175">Mean</span></span> |    <span data-ttu-id="26463-176">Erreur</span><span class="sxs-lookup"><span data-stu-id="26463-176">Error</span></span> |   <span data-ttu-id="26463-177">StdDev</span><span class="sxs-lookup"><span data-stu-id="26463-177">StdDev</span></span> |     <span data-ttu-id="26463-178">Médiane</span><span class="sxs-lookup"><span data-stu-id="26463-178">Median</span></span> | <span data-ttu-id="26463-179">Proportions</span><span class="sxs-lookup"><span data-stu-id="26463-179">Ratio</span></span> | <span data-ttu-id="26463-180">RatioSD</span><span class="sxs-lookup"><span data-stu-id="26463-180">RatioSD</span></span> |    <span data-ttu-id="26463-181">Génération 0</span><span class="sxs-lookup"><span data-stu-id="26463-181">Gen 0</span></span> |   <span data-ttu-id="26463-182">GEN 1</span><span class="sxs-lookup"><span data-stu-id="26463-182">Gen 1</span></span> | <span data-ttu-id="26463-183">Génération 2</span><span class="sxs-lookup"><span data-stu-id="26463-183">Gen 2</span></span> |  <span data-ttu-id="26463-184">Allocated</span><span class="sxs-lookup"><span data-stu-id="26463-184">Allocated</span></span> |
|----------------------- |-----------:|---------:|---------:|-----------:|------:|--------:|---------:|--------:|------:|-----------:|
|           <span data-ttu-id="26463-185">LoadEntities</span><span class="sxs-lookup"><span data-stu-id="26463-185">LoadEntities</span></span> | <span data-ttu-id="26463-186">2 860,4 US</span><span class="sxs-lookup"><span data-stu-id="26463-186">2,860.4 us</span></span> | <span data-ttu-id="26463-187">54,31 US</span><span class="sxs-lookup"><span data-stu-id="26463-187">54.31 us</span></span> | <span data-ttu-id="26463-188">93,68 US</span><span class="sxs-lookup"><span data-stu-id="26463-188">93.68 us</span></span> | <span data-ttu-id="26463-189">2 844,5 US</span><span class="sxs-lookup"><span data-stu-id="26463-189">2,844.5 us</span></span> |  <span data-ttu-id="26463-190">4.55</span><span class="sxs-lookup"><span data-stu-id="26463-190">4.55</span></span> |    <span data-ttu-id="26463-191">0,33</span><span class="sxs-lookup"><span data-stu-id="26463-191">0.33</span></span> | <span data-ttu-id="26463-192">210,9375</span><span class="sxs-lookup"><span data-stu-id="26463-192">210.9375</span></span> | <span data-ttu-id="26463-193">70,3125</span><span class="sxs-lookup"><span data-stu-id="26463-193">70.3125</span></span> |     - | <span data-ttu-id="26463-194">1309,56 KO</span><span class="sxs-lookup"><span data-stu-id="26463-194">1309.56 KB</span></span> |
| <span data-ttu-id="26463-195">LoadEntitiesNoTracking</span><span class="sxs-lookup"><span data-stu-id="26463-195">LoadEntitiesNoTracking</span></span> | <span data-ttu-id="26463-196">1 353,0 US</span><span class="sxs-lookup"><span data-stu-id="26463-196">1,353.0 us</span></span> | <span data-ttu-id="26463-197">21,26 US</span><span class="sxs-lookup"><span data-stu-id="26463-197">21.26 us</span></span> | <span data-ttu-id="26463-198">18,85 US</span><span class="sxs-lookup"><span data-stu-id="26463-198">18.85 us</span></span> | <span data-ttu-id="26463-199">1 355,6 US</span><span class="sxs-lookup"><span data-stu-id="26463-199">1,355.6 us</span></span> |  <span data-ttu-id="26463-200">2.10</span><span class="sxs-lookup"><span data-stu-id="26463-200">2.10</span></span> |    <span data-ttu-id="26463-201">0.14</span><span class="sxs-lookup"><span data-stu-id="26463-201">0.14</span></span> |  <span data-ttu-id="26463-202">87,8906</span><span class="sxs-lookup"><span data-stu-id="26463-202">87.8906</span></span> |  <span data-ttu-id="26463-203">3,9063</span><span class="sxs-lookup"><span data-stu-id="26463-203">3.9063</span></span> |     - |  <span data-ttu-id="26463-204">540,09 KO</span><span class="sxs-lookup"><span data-stu-id="26463-204">540.09 KB</span></span> |
|     <span data-ttu-id="26463-205">ProjectOnlyRanking</span><span class="sxs-lookup"><span data-stu-id="26463-205">ProjectOnlyRanking</span></span> |   <span data-ttu-id="26463-206">910,9 US</span><span class="sxs-lookup"><span data-stu-id="26463-206">910.9 us</span></span> | <span data-ttu-id="26463-207">20,91 US</span><span class="sxs-lookup"><span data-stu-id="26463-207">20.91 us</span></span> | <span data-ttu-id="26463-208">61,65 US</span><span class="sxs-lookup"><span data-stu-id="26463-208">61.65 us</span></span> |   <span data-ttu-id="26463-209">892,9 US</span><span class="sxs-lookup"><span data-stu-id="26463-209">892.9 us</span></span> |  <span data-ttu-id="26463-210">1,46</span><span class="sxs-lookup"><span data-stu-id="26463-210">1.46</span></span> |    <span data-ttu-id="26463-211">0.14</span><span class="sxs-lookup"><span data-stu-id="26463-211">0.14</span></span> |  <span data-ttu-id="26463-212">41,0156</span><span class="sxs-lookup"><span data-stu-id="26463-212">41.0156</span></span> |  <span data-ttu-id="26463-213">0,9766</span><span class="sxs-lookup"><span data-stu-id="26463-213">0.9766</span></span> |     - |  <span data-ttu-id="26463-214">252,08 KO</span><span class="sxs-lookup"><span data-stu-id="26463-214">252.08 KB</span></span> |
|    <span data-ttu-id="26463-215">CalculateInDatabase</span><span class="sxs-lookup"><span data-stu-id="26463-215">CalculateInDatabase</span></span> |   <span data-ttu-id="26463-216">627,1 US</span><span class="sxs-lookup"><span data-stu-id="26463-216">627.1 us</span></span> | <span data-ttu-id="26463-217">14,58 US</span><span class="sxs-lookup"><span data-stu-id="26463-217">14.58 us</span></span> | <span data-ttu-id="26463-218">42,54 US</span><span class="sxs-lookup"><span data-stu-id="26463-218">42.54 us</span></span> |   <span data-ttu-id="26463-219">626,4 US</span><span class="sxs-lookup"><span data-stu-id="26463-219">626.4 us</span></span> |  <span data-ttu-id="26463-220">1.00</span><span class="sxs-lookup"><span data-stu-id="26463-220">1.00</span></span> |    <span data-ttu-id="26463-221">0,00</span><span class="sxs-lookup"><span data-stu-id="26463-221">0.00</span></span> |   <span data-ttu-id="26463-222">4,8828</span><span class="sxs-lookup"><span data-stu-id="26463-222">4.8828</span></span> |       - |     - |   <span data-ttu-id="26463-223">33,27 KO</span><span class="sxs-lookup"><span data-stu-id="26463-223">33.27 KB</span></span> |

> [!NOTE]
> <span data-ttu-id="26463-224">À mesure que les méthodes instancient et suppriment le contexte dans la méthode, ces opérations sont comptabilisées pour le test d’évaluation, bien qu’elles ne fassent pas partie du processus d’interrogation.</span><span class="sxs-lookup"><span data-stu-id="26463-224">As the methods instantiate and dispose the context within the method, these operations are counted for the benchmark, although strictly speaking they are not part of the querying process.</span></span> <span data-ttu-id="26463-225">Cela n’a pas d’importance si l’objectif est de comparer deux alternatives les unes aux autres (puisque l’instanciation et la suppression de contexte sont les mêmes) et fournit une mesure plus holistique pour l’ensemble de l’opération.</span><span class="sxs-lookup"><span data-stu-id="26463-225">This should not matter if the goal is to compare two alternatives to one another (since the context instantiation and disposal are the same), and gives a more holistic measurement for the entire operation.</span></span>

<span data-ttu-id="26463-226">L’une des limitations de BenchmarkDotNet est qu’il mesure les performances simples et uniques des méthodes que vous fournissez, et n’est donc pas bien adapté à l’évaluation des scénarios simultanés.</span><span class="sxs-lookup"><span data-stu-id="26463-226">One limitation of BenchmarkDotNet is that it measures simple, single-thread performance of the methods you provide, and is therefore not well-suited for benchmarking concurrent scenarios.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="26463-227">Veillez à toujours faire en sorte que les données de votre base de données soient similaires aux données de production lors de l’évaluation. dans le cas contraire, les résultats du benchmark peuvent ne pas représenter les performances réelles en production.</span><span class="sxs-lookup"><span data-stu-id="26463-227">Always make sure to have data in your database that is similar to production data when benchmarking, otherwise the benchmark results may not represent actual performance in production.</span></span>
