---
title: Utilisation des types de référence Nullable-EF Core
description: Utilisation des types de référence Nullable C# lors de l’utilisation de Entity Framework Core
author: roji
ms.date: 09/09/2019
uid: core/miscellaneous/nullable-reference-types
ms.openlocfilehash: 749fef8560c6777dcb2314126b11d2dd6a3562f8
ms.sourcegitcommit: 032a1767d7a6e42052a005f660b80372c6521e7e
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/12/2021
ms.locfileid: "98128561"
---
# <a name="working-with-nullable-reference-types"></a><span data-ttu-id="38cbb-103">Utilisation des types de référence Nullable</span><span class="sxs-lookup"><span data-stu-id="38cbb-103">Working with Nullable Reference Types</span></span>

<span data-ttu-id="38cbb-104">C# 8 a introduit une nouvelle fonctionnalité appelée [types de référence Nullable (Diagnostics proactifs NRT)](/dotnet/csharp/tutorials/nullable-reference-types), ce qui permet d’annoter des types de référence, indiquant s’il est valide qu’ils contiennent ou non des valeurs NULL.</span><span class="sxs-lookup"><span data-stu-id="38cbb-104">C# 8 introduced a new feature called [nullable reference types (NRT)](/dotnet/csharp/tutorials/nullable-reference-types), allowing reference types to be annotated, indicating whether it is valid for them to contain null or not.</span></span> <span data-ttu-id="38cbb-105">Si vous débutez avec cette fonctionnalité, il est recommandé de vous familiariser avec elle en lisant les documents C#.</span><span class="sxs-lookup"><span data-stu-id="38cbb-105">If you are new to this feature, it is recommended that make yourself familiar with it by reading the C# docs.</span></span>

<span data-ttu-id="38cbb-106">Cette page présente la prise en charge de EF Core pour les types de référence Nullable et décrit les pratiques recommandées pour l’utiliser.</span><span class="sxs-lookup"><span data-stu-id="38cbb-106">This page introduces EF Core's support for nullable reference types, and describes best practices for working with them.</span></span>

## <a name="required-and-optional-properties"></a><span data-ttu-id="38cbb-107">Propriétés obligatoires et facultatives</span><span class="sxs-lookup"><span data-stu-id="38cbb-107">Required and optional properties</span></span>

<span data-ttu-id="38cbb-108">La documentation principale sur les propriétés obligatoires et facultatives et leur interaction avec les types de référence Nullable sont les pages de [Propriétés obligatoires et facultatives](xref:core/modeling/entity-properties#required-and-optional-properties) .</span><span class="sxs-lookup"><span data-stu-id="38cbb-108">The main documentation on required and optional properties and their interaction with nullable reference types is the [Required and Optional Properties](xref:core/modeling/entity-properties#required-and-optional-properties) page.</span></span> <span data-ttu-id="38cbb-109">Il est recommandé de commencer par lire cette page en premier.</span><span class="sxs-lookup"><span data-stu-id="38cbb-109">It is recommended you start out by reading that page first.</span></span>

> [!NOTE]
> <span data-ttu-id="38cbb-110">Soyez prudent lorsque vous activez les types de référence Nullable sur un projet existant : les propriétés de type de référence qui ont été précédemment configurées comme étant facultatives sont maintenant configurées comme obligatoires, sauf si elles sont explicitement annotées comme nullables.</span><span class="sxs-lookup"><span data-stu-id="38cbb-110">Exercise caution when enabling nullable reference types on an existing project: reference type properties which were previously configured as optional will now be configured as required, unless they are explicitly annotated to be nullable.</span></span> <span data-ttu-id="38cbb-111">Lors de la gestion d’un schéma de base de données relationnelle, des migrations peuvent être générées, ce qui modifie la possibilité de valeur null de la colonne de base de données.</span><span class="sxs-lookup"><span data-stu-id="38cbb-111">When managing a relational database schema, this may cause migrations to be generated which alter the database column's nullability.</span></span>

## <a name="non-nullable-properties-and-initialization"></a><span data-ttu-id="38cbb-112">Propriétés et initialisation non Nullable</span><span class="sxs-lookup"><span data-stu-id="38cbb-112">Non-nullable properties and initialization</span></span>

<span data-ttu-id="38cbb-113">Lorsque les types de référence Nullable sont activés, le compilateur C# émet des avertissements pour toute propriété non Nullable non initialisée, car elles contiennent NULL.</span><span class="sxs-lookup"><span data-stu-id="38cbb-113">When nullable reference types are enabled, the C# compiler emits warnings for any uninitialized non-nullable property, as these would contain null.</span></span> <span data-ttu-id="38cbb-114">Par conséquent, la méthode courante suivante pour écrire des types d’entité ne peut pas être utilisée :</span><span class="sxs-lookup"><span data-stu-id="38cbb-114">As a result, the following, common way of writing entity types cannot be used:</span></span>

[!code-csharp[Main](../../../samples/core/Miscellaneous/NullableReferenceTypes/CustomerWithWarning.cs?name=CustomerWithWarning&highlight=4-5)]

<span data-ttu-id="38cbb-115">La [liaison de constructeur](xref:core/modeling/constructors) est une technique utile pour s’assurer que les propriétés non Nullable sont initialisées :</span><span class="sxs-lookup"><span data-stu-id="38cbb-115">[Constructor binding](xref:core/modeling/constructors) is a useful technique to ensure that your non-nullable properties are initialized:</span></span>

[!code-csharp[Main](../../../samples/core/Miscellaneous/NullableReferenceTypes/CustomerWithConstructorBinding.cs?name=CustomerWithConstructorBinding&highlight=6-9)]

<span data-ttu-id="38cbb-116">Malheureusement, dans certains scénarios, la liaison de constructeur n’est pas une option. les propriétés de navigation, par exemple, ne peuvent pas être initialisées de cette manière.</span><span class="sxs-lookup"><span data-stu-id="38cbb-116">Unfortunately, in some scenarios constructor binding isn't an option; navigation properties, for example, cannot be initialized in this way.</span></span>

<span data-ttu-id="38cbb-117">Les propriétés de navigation requises présentent une difficulté supplémentaire : bien qu’une fonction dépendante existe toujours pour un principal donné, elle peut ou non être chargée par une requête particulière, en fonction des besoins à ce stade du programme ([voir les différents modèles de chargement des données](xref:core/querying/related-data)).</span><span class="sxs-lookup"><span data-stu-id="38cbb-117">Required navigation properties present an additional difficulty: although a dependent will always exist for a given principal, it may or may not be loaded by a particular query, depending on the needs at that point in the program ([see the different patterns for loading data](xref:core/querying/related-data)).</span></span> <span data-ttu-id="38cbb-118">En même temps, il n’est pas souhaitable de rendre ces propriétés Nullable, car cela force tous les accès à vérifier la valeur null, même si elles sont requises.</span><span class="sxs-lookup"><span data-stu-id="38cbb-118">At the same time, it is undesirable to make these properties nullable, since that would force all access to them to check for null, even if they are required.</span></span>

<span data-ttu-id="38cbb-119">Une façon de traiter ces scénarios consiste à avoir une propriété qui n’accepte pas les valeurs NULL avec un [champ de stockage](xref:core/modeling/backing-field)Nullable :</span><span class="sxs-lookup"><span data-stu-id="38cbb-119">One way to deal with these scenarios, is to have a non-nullable property with a nullable [backing field](xref:core/modeling/backing-field):</span></span>

[!code-csharp[Main](../../../samples/core/Miscellaneous/NullableReferenceTypes/Order.cs?range=10-17)]

<span data-ttu-id="38cbb-120">Étant donné que la propriété de navigation n’accepte pas les valeurs NULL, une navigation requise est configurée ; tant que la navigation est chargée correctement, le dépendant est accessible via la propriété.</span><span class="sxs-lookup"><span data-stu-id="38cbb-120">Since the navigation property is non-nullable, a required navigation is configured; and as long as the navigation is properly loaded, the dependent will be accessible via the property.</span></span> <span data-ttu-id="38cbb-121">Toutefois, si vous accédez à la propriété sans avoir au préalable chargé l’entité associée, une exception InvalidOperationException est levée, car le contrat d’API a été utilisé incorrectement.</span><span class="sxs-lookup"><span data-stu-id="38cbb-121">If, however, the property is accessed without first properly loading the related entity, an InvalidOperationException is thrown, since the API contract has been used incorrectly.</span></span> <span data-ttu-id="38cbb-122">Notez que EF doit être configuré pour toujours accéder au champ de stockage et non à la propriété, car il s’appuie sur la possibilité de lire la valeur même quand elle est désactivée ; consultez la documentation sur les [champs de stockage](xref:core/modeling/backing-field) pour savoir comment procéder, et envisagez de spécifier pour vous `PropertyAccessMode.Field` assurer que la configuration est correcte.</span><span class="sxs-lookup"><span data-stu-id="38cbb-122">Note that EF must be configured to always access the backing field and not the property, as it relies on being able to read the value even when unset; consult the documentation on [backing fields](xref:core/modeling/backing-field) on how to do this, and consider specifying `PropertyAccessMode.Field` to make sure the configuration is correct.</span></span>

<span data-ttu-id="38cbb-123">En guise d’alternative terser, il est possible d’initialiser simplement la propriété avec la valeur null à l’aide de l’opérateur null-indulgent avec ( !) :</span><span class="sxs-lookup"><span data-stu-id="38cbb-123">As a terser alternative, it is possible to simply initialize the property to null with the help of the null-forgiving operator (!):</span></span>

[!code-csharp[Main](../../../samples/core/Miscellaneous/NullableReferenceTypes/Order.cs?range=19)]

<span data-ttu-id="38cbb-124">Une valeur null réelle ne sera jamais observée, sauf en raison d’un bogue de programmation, par exemple l’accès à la propriété de navigation sans charger correctement l’entité associée au préalable.</span><span class="sxs-lookup"><span data-stu-id="38cbb-124">An actual null value will never be observed except as a result of a programming bug, e.g. accessing the navigation property without properly loading the related entity beforehand.</span></span>

> [!NOTE]
> <span data-ttu-id="38cbb-125">Les navigations de collection, qui contiennent des références à plusieurs entités associées, doivent toujours être non Nullable.</span><span class="sxs-lookup"><span data-stu-id="38cbb-125">Collection navigations, which contain references to multiple related entities, should always be non-nullable.</span></span> <span data-ttu-id="38cbb-126">Une collection vide signifie qu’il n’existe aucune entité associée, mais que la liste elle-même ne doit jamais être null.</span><span class="sxs-lookup"><span data-stu-id="38cbb-126">An empty collection means that no related entities exist, but the list itself should never be null.</span></span>

## <a name="dbcontext-and-dbset"></a><span data-ttu-id="38cbb-127">DbContext et DbSet</span><span class="sxs-lookup"><span data-stu-id="38cbb-127">DbContext and DbSet</span></span>

<span data-ttu-id="38cbb-128">La pratique courante consistant à avoir des propriétés DbSet non initialisées sur les types de contexte est également problématique, car le compilateur émet désormais des avertissements pour eux.</span><span class="sxs-lookup"><span data-stu-id="38cbb-128">The common practice of having uninitialized DbSet properties on context types is also problematic, as the compiler will now emit warnings for them.</span></span> <span data-ttu-id="38cbb-129">Ce problème peut être résolu comme suit :</span><span class="sxs-lookup"><span data-stu-id="38cbb-129">This can be fixed as follows:</span></span>

[!code-csharp[Main](../../../samples/core/Miscellaneous/NullableReferenceTypes/NullableReferenceTypesContext.cs?name=Context&highlight=3-4)]

<span data-ttu-id="38cbb-130">Une autre stratégie consiste à utiliser des propriétés automatiques qui n’acceptent pas les valeurs NULL, mais à les initialiser avec la valeur null, en utilisant l’opérateur null-indulgent avec ( !) pour interrompre l’avertissement du compilateur.</span><span class="sxs-lookup"><span data-stu-id="38cbb-130">Another strategy is to use non-nullable auto-properties, but to initialize them to null, using the null-forgiving operator (!) to silence the compiler warning.</span></span> <span data-ttu-id="38cbb-131">Le constructeur DbContext de base garantit que toutes les propriétés DbSet seront initialisées et que la valeur NULL ne sera jamais observée sur celles-ci.</span><span class="sxs-lookup"><span data-stu-id="38cbb-131">The DbContext base constructor ensures that all DbSet properties will get initialized, and null will never be observed on them.</span></span>

## <a name="navigating-and-including-nullable-relationships"></a><span data-ttu-id="38cbb-132">Navigation et inclusion des relations Nullable</span><span class="sxs-lookup"><span data-stu-id="38cbb-132">Navigating and including nullable relationships</span></span>

<span data-ttu-id="38cbb-133">Lorsque vous traitez des relations facultatives, il est possible de rencontrer des avertissements du compilateur dans lesquels une exception de référence null réelle serait impossible.</span><span class="sxs-lookup"><span data-stu-id="38cbb-133">When dealing with optional relationships, it's possible to encounter compiler warnings where an actual null reference exception would be impossible.</span></span> <span data-ttu-id="38cbb-134">Lors de la traduction et de l’exécution de vos requêtes LINQ, EF Core garantit que si une entité associée facultative n’existe pas, toute navigation vers celle-ci sera simplement ignorée, au lieu d’être levée.</span><span class="sxs-lookup"><span data-stu-id="38cbb-134">When translating and executing your LINQ queries, EF Core guarantees that if an optional related entity does not exist, any navigation to it will simply be ignored, rather than throwing.</span></span> <span data-ttu-id="38cbb-135">Toutefois, le compilateur ne tient pas compte de cette EF Core garantie et génère des avertissements comme si la requête LINQ avait été exécutée en mémoire, avec LINQ to Objects.</span><span class="sxs-lookup"><span data-stu-id="38cbb-135">However, the compiler is unaware of this EF Core guarantee, and produces warnings as if the LINQ query were executed in memory, with LINQ to Objects.</span></span> <span data-ttu-id="38cbb-136">Par conséquent, il est nécessaire d’utiliser l’opérateur null-indulgent avec ( !) pour informer le compilateur qu’une valeur null réelle n’est pas possible :</span><span class="sxs-lookup"><span data-stu-id="38cbb-136">As a result, it is necessary to use the null-forgiving operator (!) to inform the compiler that an actual null value isn't possible:</span></span>

[!code-csharp[Main](../../../samples/core/Miscellaneous/NullableReferenceTypes/Program.cs?range=46)]

<span data-ttu-id="38cbb-137">Un problème similaire se produit lors de l’inclusion de plusieurs niveaux de relations dans les navigations facultatives :</span><span class="sxs-lookup"><span data-stu-id="38cbb-137">A similar issue occurs when including multiple levels of relationships across optional navigations:</span></span>

[!code-csharp[Main](../../../samples/core/Miscellaneous/NullableReferenceTypes/Program.cs?range=36-39&highlight=2)]

<span data-ttu-id="38cbb-138">Si vous effectuez cette tâche beaucoup et que les types d’entité en question sont principalement utilisés dans les requêtes EF Core, envisagez de rendre les propriétés de navigation non Nullable et de les configurer comme facultatives via l’API Fluent ou les annotations de données.</span><span class="sxs-lookup"><span data-stu-id="38cbb-138">If you find yourself doing this a lot, and the entity types in question are predominantly (or exclusively) used in EF Core queries, consider making the navigation properties non-nullable, and to configure them as optional via the Fluent API or Data Annotations.</span></span> <span data-ttu-id="38cbb-139">Cela supprimera tous les avertissements du compilateur tout en gardant la relation facultative ; Toutefois, si vos entités sont parcourues en dehors de EF Core, vous pouvez observer des valeurs NULL, même si les propriétés sont annotées comme n’acceptant pas les valeurs NULL.</span><span class="sxs-lookup"><span data-stu-id="38cbb-139">This will remove all compiler warnings while keeping the relationship optional; however, if your entities are traversed outside of EF Core, you may observe null values although the properties are annotated as non-nullable.</span></span>

## <a name="limitations"></a><span data-ttu-id="38cbb-140">Limites</span><span class="sxs-lookup"><span data-stu-id="38cbb-140">Limitations</span></span>

* <span data-ttu-id="38cbb-141">L’ingénierie à rebours ne prend actuellement pas en charge les [types référence Nullable C# 8 (NRTs)](/dotnet/csharp/tutorials/nullable-reference-types): EF Core génère toujours du code c# qui suppose que la fonctionnalité est désactivée.</span><span class="sxs-lookup"><span data-stu-id="38cbb-141">Reverse engineering does not currently support [C# 8 nullable reference types (NRTs)](/dotnet/csharp/tutorials/nullable-reference-types): EF Core always generates C# code that assumes the feature is off.</span></span> <span data-ttu-id="38cbb-142">Par exemple, les colonnes de texte Nullable seront échafaudées en tant que propriété de type `string` , et non `string?` , avec l’API Fluent ou les annotations de données utilisées pour configurer si une propriété est requise ou non.</span><span class="sxs-lookup"><span data-stu-id="38cbb-142">For example, nullable text columns will be scaffolded as a property with type `string` , not `string?`, with either the Fluent API or Data Annotations used to configure whether a property is required or not.</span></span> <span data-ttu-id="38cbb-143">Vous pouvez modifier le code de génération de modèles automatique et les remplacer par des annotations de possibilité de valeur null.</span><span class="sxs-lookup"><span data-stu-id="38cbb-143">You can edit the scaffolded code and replace these with C# nullability annotations.</span></span> <span data-ttu-id="38cbb-144">La prise en charge de la génération de modèles automatique pour les types de référence Nullable est suivie par le problème [#15520](https://github.com/dotnet/efcore/issues/15520).</span><span class="sxs-lookup"><span data-stu-id="38cbb-144">Scaffolding support for nullable reference types is tracked by issue [#15520](https://github.com/dotnet/efcore/issues/15520).</span></span>
* <span data-ttu-id="38cbb-145">La surface de l’API publique de EF Core n’a pas encore été annotée pour la possibilité de valeur null (l’API publique est « null-oublie »), ce qui peut parfois être difficile à utiliser lorsque la fonctionnalité Diagnostics proactifs NRT est activée.</span><span class="sxs-lookup"><span data-stu-id="38cbb-145">EF Core's public API surface has not yet been annotated for nullability (the public API is "null-oblivious"), making it sometimes awkward to use when the NRT feature is turned on.</span></span> <span data-ttu-id="38cbb-146">Cela comprend notamment les opérateurs LINQ Async exposés par EF Core, tels que [FirstOrDefaultAsync](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.firstordefaultasync#Microsoft_EntityFrameworkCore_EntityFrameworkQueryableExtensions_FirstOrDefaultAsync__1_System_Linq_IQueryable___0__System_Linq_Expressions_Expression_System_Func___0_System_Boolean___System_Threading_CancellationToken_).</span><span class="sxs-lookup"><span data-stu-id="38cbb-146">This notably includes the async LINQ operators exposed by EF Core, such as [FirstOrDefaultAsync](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.firstordefaultasync#Microsoft_EntityFrameworkCore_EntityFrameworkQueryableExtensions_FirstOrDefaultAsync__1_System_Linq_IQueryable___0__System_Linq_Expressions_Expression_System_Func___0_System_Boolean___System_Threading_CancellationToken_).</span></span> <span data-ttu-id="38cbb-147">Nous prévoyons de le résoudre pour la version 6,0.</span><span class="sxs-lookup"><span data-stu-id="38cbb-147">We plan to address this for the 6.0 release.</span></span>
