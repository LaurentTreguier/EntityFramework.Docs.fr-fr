---
title: Regroupement DbContext
description: Regroupement DbContext dans Entity Framework Core
author: rick-anderson
ms.author: riande
ms.date: 9/19/2020
uid: core/miscellaneous/context-pooling
ms.openlocfilehash: fd5f53ff97a73895f0c4239439730dd8cb3ecc29
ms.sourcegitcommit: c0e6a00b64c2dcd8acdc0fe6d1b47703405cdf09
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 09/24/2020
ms.locfileid: "91215599"
---
# <a name="dbcontext-pooling"></a><span data-ttu-id="2b57a-103">Regroupement DbContext</span><span class="sxs-lookup"><span data-stu-id="2b57a-103">DbContext pooling</span></span>

<span data-ttu-id="2b57a-104">`AddDbContextPool` active le regroupement d' `DbContext` instances.</span><span class="sxs-lookup"><span data-stu-id="2b57a-104">`AddDbContextPool` enables pooling of `DbContext` instances.</span></span> <span data-ttu-id="2b57a-105">Le regroupement de contexte peut augmenter le débit dans des scénarios à grande échelle tels que les serveurs Web en réutilisant des instances de contexte, plutôt que de créer des instances pour chaque demande.</span><span class="sxs-lookup"><span data-stu-id="2b57a-105">Context pooling can increase throughput in high-scale scenarios such as web servers by reusing context instances, rather than creating new instances for each request.</span></span>

<span data-ttu-id="2b57a-106">Le modèle typique d’une application ASP.NET Core utilisant EF Core implique l’inscription d’un type personnalisé dans <xref:Microsoft.EntityFrameworkCore.DbContext> le conteneur d' [injection de dépendances](/aspnet/core/fundamentals/dependency-injection) et l’obtention d’instances de ce type par le biais de paramètres de constructeur dans les contrôleurs ou les Razor pages.</span><span class="sxs-lookup"><span data-stu-id="2b57a-106">The typical pattern in an ASP.NET Core app using EF Core involves registering a custom <xref:Microsoft.EntityFrameworkCore.DbContext> type into the [dependency injection](/aspnet/core/fundamentals/dependency-injection) container and obtaining instances of that type through constructor parameters in controllers or Razor Pages.</span></span> <span data-ttu-id="2b57a-107">À l’aide de l’injection de constructeur, une nouvelle instance de contexte est créée pour chaque requête.</span><span class="sxs-lookup"><span data-stu-id="2b57a-107">Using constructor injection, a new context instance is created for each request.</span></span>

<span data-ttu-id="2b57a-108"><xref:Microsoft.Extensions.DependencyInjection.EntityFrameworkServiceCollectionExtensions.AddDbContextPool%2A> active un pool d’instances de contexte réutilisables.</span><span class="sxs-lookup"><span data-stu-id="2b57a-108"><xref:Microsoft.Extensions.DependencyInjection.EntityFrameworkServiceCollectionExtensions.AddDbContextPool%2A> enables a pool of reusable context instances.</span></span> <span data-ttu-id="2b57a-109">Pour utiliser le regroupement de contexte, utilisez la `AddDbContextPool` méthode au lieu de lors de l' `AddDbContext` inscription du service :</span><span class="sxs-lookup"><span data-stu-id="2b57a-109">To use context pooling, use the `AddDbContextPool` method instead of `AddDbContext` during service registration:</span></span>

``` csharp
services.AddDbContextPool<BloggingContext>(
    options => options.UseSqlServer(connectionString));
```

<span data-ttu-id="2b57a-110">Lorsque `AddDbContextPool` est utilisé, au moment où une instance de contexte est demandée, EF vérifie d’abord si une instance est disponible dans le pool.</span><span class="sxs-lookup"><span data-stu-id="2b57a-110">When `AddDbContextPool` is used, at the time a context instance is requested, EF first checks if there is an instance available in the pool.</span></span> <span data-ttu-id="2b57a-111">Une fois finalisé le traitement de la demande, tout état sur l’instance est réinitialisé et l’instance elle-même est retournée au pool.</span><span class="sxs-lookup"><span data-stu-id="2b57a-111">Once the request processing finalizes, any state on the instance is reset and the instance is itself returned to the pool.</span></span>

<span data-ttu-id="2b57a-112">Ce concept est similaire à celui de l’utilisation du regroupement de connexions dans les fournisseurs ADO.NET et présente l’avantage d’enregistrer un certain coût d’initialisation de l’instance de contexte.</span><span class="sxs-lookup"><span data-stu-id="2b57a-112">This is conceptually similar to how connection pooling operates in ADO.NET providers and has the advantage of saving some of the cost of initialization of the context instance.</span></span>

<span data-ttu-id="2b57a-113">Le `poolSize` paramètre de <xref:Microsoft.Extensions.DependencyInjection.EntityFrameworkServiceCollectionExtensions.AddDbContextPool%2A> définit le nombre maximal d’instances conservées par le pool.</span><span class="sxs-lookup"><span data-stu-id="2b57a-113">The `poolSize` parameter of <xref:Microsoft.Extensions.DependencyInjection.EntityFrameworkServiceCollectionExtensions.AddDbContextPool%2A> sets the maximum number of instances retained by the pool.</span></span> <span data-ttu-id="2b57a-114">Une fois que `poolSize` est dépassé, les nouvelles instances de contexte ne sont pas mises en cache et EF revient au comportement de non-regroupement de la création d’instances à la demande.</span><span class="sxs-lookup"><span data-stu-id="2b57a-114">Once `poolSize` is exceeded, new context instances are not cached and  EF falls back to the non-pooling behavior of creating instances on demand.</span></span>

## <a name="limitations"></a><span data-ttu-id="2b57a-115">Limites</span><span class="sxs-lookup"><span data-stu-id="2b57a-115">Limitations</span></span>

<span data-ttu-id="2b57a-116">Les applications doivent être profilées et testées pour montrer que l’initialisation du contexte est un coût significatif.</span><span class="sxs-lookup"><span data-stu-id="2b57a-116">Apps should be profiled and tested to show that context initialization is a significant cost.</span></span>

<span data-ttu-id="2b57a-117">`AddDbContextPool` présente quelques limitations sur ce qui peut être fait dans la `OnConfiguring` méthode du contexte.</span><span class="sxs-lookup"><span data-stu-id="2b57a-117">`AddDbContextPool` has a few limitations on what can be done in the `OnConfiguring` method of the context.</span></span>

> [!WARNING]  
> <span data-ttu-id="2b57a-118">Évitez d’utiliser le regroupement de contexte dans les applications qui maintiennent l’État.</span><span class="sxs-lookup"><span data-stu-id="2b57a-118">Avoid using context pooling in apps that maintain state.</span></span> <span data-ttu-id="2b57a-119">Par exemple, les champs privés dans le contexte qui ne doivent pas être partagés entre les requêtes.</span><span class="sxs-lookup"><span data-stu-id="2b57a-119">For example, private fields in the context that shouldn't be shared across requests.</span></span> <span data-ttu-id="2b57a-120">EF Core réinitialise uniquement l’État qu’il reconnaît avant d’ajouter une instance de contexte au pool.</span><span class="sxs-lookup"><span data-stu-id="2b57a-120">EF Core only resets the state that it is aware of before adding a context instance to the pool.</span></span>

<span data-ttu-id="2b57a-121">Le regroupement de contexte fonctionne en réutilisant la même instance de contexte entre les requêtes.</span><span class="sxs-lookup"><span data-stu-id="2b57a-121">Context pooling works by reusing the same context instance across requests.</span></span> <span data-ttu-id="2b57a-122">Cela signifie qu’elle est enregistrée en tant que [Singleton](/aspnet/core/fundamentals/dependency-injection#service-lifetimes) en termes de l’instance elle-même afin de pouvoir être persistante.</span><span class="sxs-lookup"><span data-stu-id="2b57a-122">This means that it's effectively registered as a [Singleton](/aspnet/core/fundamentals/dependency-injection#service-lifetimes) in terms of the instance itself so that it's able to persist.</span></span>

<span data-ttu-id="2b57a-123">Le regroupement de contexte est destiné aux scénarios dans lesquels la configuration de contexte, qui comprend les services résolus, est fixée entre les demandes.</span><span class="sxs-lookup"><span data-stu-id="2b57a-123">Context pooling is intended for scenarios where the context configuration, which includes services resolved, is fixed between requests.</span></span> <span data-ttu-id="2b57a-124">Dans les cas où des services [délimités](/aspnet/core/fundamentals/dependency-injection#service-lifetimes) sont requis ou si la configuration doit être modifiée, n’utilisez pas le regroupement.</span><span class="sxs-lookup"><span data-stu-id="2b57a-124">For cases where [Scoped](/aspnet/core/fundamentals/dependency-injection#service-lifetimes) services are required, or configuration needs to be changed, don't use pooling.</span></span> <span data-ttu-id="2b57a-125">Le gain de performances par rapport au regroupement est généralement négligeable, sauf dans les scénarios hautement optimisés.</span><span class="sxs-lookup"><span data-stu-id="2b57a-125">The performance gain from pooling is usually negligible except in highly optimized scenarios.</span></span>
