---
title: Amélioration des performances de démarrage avec NGen-EF6
author: divega
ms.date: 10/23/2016
ms.assetid: dc6110a0-80a0-4370-8190-cea942841cee
ms.openlocfilehash: 841aec645abdb2a56076d0b70bfb2614b0acafb4
ms.sourcegitcommit: 37d0e0fd1703467918665a64837dc54ad2ec7484
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 10/16/2019
ms.locfileid: "72445997"
---
# <a name="improving-startup-performance-with-ngen"></a><span data-ttu-id="ca17e-102">Amélioration des performances de démarrage avec NGen</span><span class="sxs-lookup"><span data-stu-id="ca17e-102">Improving startup performance with NGen</span></span>
> [!NOTE]
> <span data-ttu-id="ca17e-103">**EF6 et versions ultérieures uniquement** : Les fonctionnalités, les API, etc. décrites dans cette page ont été introduites dans Entity Framework 6.</span><span class="sxs-lookup"><span data-stu-id="ca17e-103">**EF6 Onwards Only** - The features, APIs, etc. discussed in this page were introduced in Entity Framework 6.</span></span> <span data-ttu-id="ca17e-104">Si vous utilisez une version antérieure, certaines ou toutes les informations ne s’appliquent pas.</span><span class="sxs-lookup"><span data-stu-id="ca17e-104">If you are using an earlier version, some or all of the information does not apply.</span></span>  

<span data-ttu-id="ca17e-105">Le .NET Framework prend en charge la génération d’images natives pour les applications et les bibliothèques managées afin d’aider les applications à démarrer plus rapidement et, dans certains cas, à utiliser moins de mémoire.</span><span class="sxs-lookup"><span data-stu-id="ca17e-105">The .NET Framework supports the generation of native images for managed applications and libraries as a way to help applications start faster and also in some cases use less memory.</span></span> <span data-ttu-id="ca17e-106">Les images natives sont créées en traduisant les assemblys de code managé en fichiers contenant des instructions machine natives avant l’exécution de l’application, ce qui allège le compilateur .NET JIT (juste-à-temps) d’avoir à générer les instructions natives à l’adresse exécution de l’application.</span><span class="sxs-lookup"><span data-stu-id="ca17e-106">Native images are created by translating managed code assemblies into files containing native machine instructions before the application is executed, relieving the .NET JIT (Just-In-Time) compiler from having to generate the native instructions at application runtime.</span></span>  

<span data-ttu-id="ca17e-107">Avant la version 6, les bibliothèques principales du runtime EF faisaient partie du .NET Framework et les images natives ont été générées automatiquement.</span><span class="sxs-lookup"><span data-stu-id="ca17e-107">Prior to version 6, the EF runtime’s core libraries were part of the .NET Framework and native images were generated automatically for them.</span></span> <span data-ttu-id="ca17e-108">Depuis la version 6, l’intégralité du runtime EF a été combinée dans le package NuGet EntityFramework.</span><span class="sxs-lookup"><span data-stu-id="ca17e-108">Starting with version 6 the whole EF runtime has been combined into the EntityFramework NuGet package.</span></span> <span data-ttu-id="ca17e-109">Les images natives doivent maintenant être générées à l’aide de l’outil en ligne de commande NGen. exe pour obtenir des résultats similaires.</span><span class="sxs-lookup"><span data-stu-id="ca17e-109">Native images have to now be generated using the NGen.exe command line tool to obtain similar results.</span></span>  

<span data-ttu-id="ca17e-110">Les observations empiriques montrent que les images natives des assemblys du runtime EF peuvent réduire de 1 à 3 secondes le temps de démarrage de l’application.</span><span class="sxs-lookup"><span data-stu-id="ca17e-110">Empirical observations show that native images of the EF runtime assemblies can cut between 1 and 3 seconds of application startup time.</span></span>  

## <a name="how-to-use-ngenexe"></a><span data-ttu-id="ca17e-111">Comment utiliser NGen. exe</span><span class="sxs-lookup"><span data-stu-id="ca17e-111">How to use NGen.exe</span></span>  

<span data-ttu-id="ca17e-112">La fonction la plus basique de l’outil NGen. exe consiste à « installer » (autrement dit, pour créer et rendre persistant sur disque) des images natives pour un assembly et toutes ses dépendances directes.</span><span class="sxs-lookup"><span data-stu-id="ca17e-112">The most basic function of the NGen.exe tool is to “install” (that is, to create and persist to disk) native images for an assembly and all its direct dependencies.</span></span> <span data-ttu-id="ca17e-113">Voici comment y parvenir :</span><span class="sxs-lookup"><span data-stu-id="ca17e-113">Here is how you can achieve that:</span></span>  

1. <span data-ttu-id="ca17e-114">Ouvrez une fenêtre d’invite de commandes en tant qu’administrateur.</span><span class="sxs-lookup"><span data-stu-id="ca17e-114">Open a Command Prompt window as an administrator.</span></span>
2. <span data-ttu-id="ca17e-115">Remplacez le répertoire de travail actuel par l’emplacement des assemblys pour lesquels vous souhaitez générer des images natives :</span><span class="sxs-lookup"><span data-stu-id="ca17e-115">Change the current working directory to the location of the assemblies you want to generate native images for:</span></span>

   ``` console
   cd <*Assemblies location*>  
   ```

3. <span data-ttu-id="ca17e-116">En fonction de votre système d’exploitation et de la configuration de l’application, vous devrez peut-être générer des images natives pour l’architecture 32 bits, l’architecture 64 bits ou pour les deux.</span><span class="sxs-lookup"><span data-stu-id="ca17e-116">Depending on your operating system and the application’s configuration you might need to generate native images for 32 bit architecture, 64 bit architecture or for both.</span></span>

   <span data-ttu-id="ca17e-117">Pour une exécution de 32 bits :</span><span class="sxs-lookup"><span data-stu-id="ca17e-117">For 32 bit run:</span></span>

   ``` console
   %WINDIR%\Microsoft.NET\Framework\v4.0.30319\ngen install <Assembly name>  
   ```

   <span data-ttu-id="ca17e-118">Pour une exécution de 64 bits :</span><span class="sxs-lookup"><span data-stu-id="ca17e-118">For 64 bit run:</span></span>
  
   ``` console
   %WINDIR%\Microsoft.NET\Framework64\v4.0.30319\ngen install <Assembly name>  
   ```

> [!TIP]
> <span data-ttu-id="ca17e-119">La génération d’images natives pour une architecture incorrecte est une erreur très courante.</span><span class="sxs-lookup"><span data-stu-id="ca17e-119">Generating native images for the wrong architecture is a very common mistake.</span></span> <span data-ttu-id="ca17e-120">En cas de doute, vous pouvez simplement générer des images natives pour toutes les architectures qui s’appliquent au système d’exploitation installé sur l’ordinateur.</span><span class="sxs-lookup"><span data-stu-id="ca17e-120">When in doubt you can simply generate native images for all the architectures that apply to the operating system installed in the machine.</span></span>  

<span data-ttu-id="ca17e-121">NGen. exe prend également en charge d’autres fonctions, telles que la désinstallation et l’affichage des images natives installées, la mise en file d’attente de la génération de plusieurs images, etc. Pour plus d’informations sur l’utilisation, consultez la [documentation de Ngen. exe](https://msdn.microsoft.com/library/6t9t5wcf.aspx).</span><span class="sxs-lookup"><span data-stu-id="ca17e-121">NGen.exe also supports other functions such as uninstalling and displaying the installed native images, queuing the generation of multiple images, etc. For more details of usage read the [NGen.exe documentation](https://msdn.microsoft.com/library/6t9t5wcf.aspx).</span></span>  

## <a name="when-to-use-ngenexe"></a><span data-ttu-id="ca17e-122">Quand utiliser NGen. exe</span><span class="sxs-lookup"><span data-stu-id="ca17e-122">When to use NGen.exe</span></span>  

<span data-ttu-id="ca17e-123">Lorsqu’il s’agit de déterminer les assemblys pour lesquels générer des images natives dans une application basée sur EF version 6 ou ultérieure, vous devez prendre en compte les options suivantes :</span><span class="sxs-lookup"><span data-stu-id="ca17e-123">When it comes to decide which assemblies to generate native images for in an application based on EF version 6 or greater, you should consider the following options:</span></span>  

- <span data-ttu-id="ca17e-124">**L’assembly principal du runtime EF, EntityFramework. dll**: une application EF classique exécute une quantité significative de code à partir de cet assembly au démarrage ou lors de son premier accès à la base de données.</span><span class="sxs-lookup"><span data-stu-id="ca17e-124">**The main EF runtime assembly, EntityFramework.dll**: A typical EF based application executes a significant amount of code from this assembly on startup or on its first access to the database.</span></span> <span data-ttu-id="ca17e-125">Par conséquent, la création d’images natives de cet assembly produit les plus grandes améliorations des performances de démarrage.</span><span class="sxs-lookup"><span data-stu-id="ca17e-125">Consequently, creating native images of this assembly will produce the biggest gains in startup performance.</span></span>  
- <span data-ttu-id="ca17e-126">**Tout assembly de fournisseur EF utilisé par votre application : le**temps de démarrage peut également tirer parti de la génération d’images natives.</span><span class="sxs-lookup"><span data-stu-id="ca17e-126">**Any EF provider assembly used by your application**: Startup time can also benefit slightly from generating native images of these.</span></span> <span data-ttu-id="ca17e-127">Par exemple, si l’application utilise le fournisseur EF pour SQL Server vous souhaiterez générer une image native pour EntityFramework. SqlServer. dll.</span><span class="sxs-lookup"><span data-stu-id="ca17e-127">For example, if the application uses the EF provider for SQL Server you will want to generate a native image for EntityFramework.SqlServer.dll.</span></span>  
- <span data-ttu-id="ca17e-128">Les **assemblys et autres dépendances de votre application**: la [documentation de Ngen. exe](https://msdn.microsoft.com/library/6t9t5wcf.aspx) couvre les critères généraux permettant de choisir les assemblys pour lesquels générer des images natives et l’impact des images natives sur la sécurité, des options avancées telles que «Hard Binding», des scénarios tels que l’utilisation d’images natives dans des scénarios de débogage et de profilage, etc.</span><span class="sxs-lookup"><span data-stu-id="ca17e-128">**Your application’s assemblies and other dependencies**: The [NGen.exe documentation](https://msdn.microsoft.com/library/6t9t5wcf.aspx) covers general criteria for choosing which assemblies to generate native images for and the impact of native images on security, advanced options such as “hard binding”, scenarios such as using native images in debugging and profiling scenarios, etc.</span></span>  

> [!TIP]
> <span data-ttu-id="ca17e-129">Veillez à mesurer avec soin l’impact de l’utilisation d’images natives sur les performances de démarrage et les performances globales de votre application, et comparez-les aux exigences réelles.</span><span class="sxs-lookup"><span data-stu-id="ca17e-129">Make sure you carefully measure the impact of using native images on both the startup performance and the overall performance of your application and compare them against actual requirements.</span></span> <span data-ttu-id="ca17e-130">Bien que les images natives permettent généralement d’améliorer les performances de démarrage et, dans certains cas, de réduire l’utilisation de la mémoire, tous les scénarios ne sont pas avantageux.</span><span class="sxs-lookup"><span data-stu-id="ca17e-130">While native images will generally help improve startup up performance and in some cases reduce memory usage, not all scenarios will benefit equally.</span></span> <span data-ttu-id="ca17e-131">Par exemple, lors d’une exécution stable de l’État (autrement dit, une fois que toutes les méthodes utilisées par l’application ont été appelées au moins une fois), le code généré par le compilateur JIT peut, en fait, produire des performances légèrement meilleures que les images natives.</span><span class="sxs-lookup"><span data-stu-id="ca17e-131">For instance, on steady state execution (that is, once all the methods being used by the application have been invoked at least once) code generated by the JIT compiler can in fact yield slightly better performance than native images.</span></span>  

## <a name="using-ngenexe-in-a-development-machine"></a><span data-ttu-id="ca17e-132">Utilisation de NGen. exe sur un ordinateur de développement</span><span class="sxs-lookup"><span data-stu-id="ca17e-132">Using NGen.exe in a development machine</span></span>  

<span data-ttu-id="ca17e-133">Pendant le développement, le compilateur JIT .NET offrira le meilleur compromis global pour le code qui change fréquemment.</span><span class="sxs-lookup"><span data-stu-id="ca17e-133">During development the .NET JIT compiler will offer the best overall tradeoff for code that is changing frequently.</span></span> <span data-ttu-id="ca17e-134">La génération d’images natives pour les dépendances compilées telles que les assemblys du runtime EF peut accélérer le développement et le test en coupant quelques secondes au début de chaque exécution.</span><span class="sxs-lookup"><span data-stu-id="ca17e-134">Generating native images for compiled dependencies such as the EF runtime assemblies can help accelerate development and testing by cutting a few seconds out at the beginning of each execution.</span></span>  

<span data-ttu-id="ca17e-135">L’emplacement du package NuGet pour la solution est un bon emplacement pour rechercher les assemblys du runtime EF.</span><span class="sxs-lookup"><span data-stu-id="ca17e-135">A good place to find the EF runtime assemblies is the NuGet package location for the solution.</span></span> <span data-ttu-id="ca17e-136">Par exemple, pour une application utilisant EF 6.0.2 avec SQL Server et ciblant .NET 4,5 ou une version ultérieure, vous pouvez taper la commande suivante dans une fenêtre d’invite de commandes (n’oubliez pas de l’ouvrir en tant qu’administrateur) :</span><span class="sxs-lookup"><span data-stu-id="ca17e-136">For example, for an application using EF 6.0.2 with SQL Server and targeting .NET 4.5 or greater you can type the following in a Command Prompt window (remember to open it as an administrator):</span></span>  

```console
cd <Solution directory>\packages\EntityFramework.6.0.2\lib\net45
%WINDIR%\Microsoft.NET\Framework\v4.0.30319\ngen install EntityFramework.SqlServer.dll
%WINDIR%\Microsoft.NET\Framework64\v4.0.30319\ngen install EntityFramework.SqlServer.dll
```  

> [!NOTE]
> <span data-ttu-id="ca17e-137">Cela tire parti du fait que l’installation des images natives pour le fournisseur EF pour SQL Server entraîne également l’installation par défaut des images natives pour l’assembly de runtime EF principal.</span><span class="sxs-lookup"><span data-stu-id="ca17e-137">This takes advantage of the fact that installing the native images for EF provider for SQL Server will also by default install the native images for the main EF runtime assembly.</span></span> <span data-ttu-id="ca17e-138">Cela fonctionne, car NGen. exe peut détecter que l’EntityFramework. dll est une dépendance directe de l’assembly EntityFramework. SqlServer. dll situé dans le même répertoire.</span><span class="sxs-lookup"><span data-stu-id="ca17e-138">This works because NGen.exe can detect that EntityFramework.dll is a direct dependency of the EntityFramework.SqlServer.dll assembly located in the same directory.</span></span>  

## <a name="creating-native-images-during-setup"></a><span data-ttu-id="ca17e-139">Création d’images natives pendant l’installation</span><span class="sxs-lookup"><span data-stu-id="ca17e-139">Creating native images during setup</span></span>  

<span data-ttu-id="ca17e-140">WiX Toolkit prend en charge la mise en file d’attente de la génération d’images natives pour les assemblys managés au cours de l’installation, comme expliqué dans ce [Guide de procédure](https://wixtoolset.org/documentation/manual/v3/howtos/files_and_registry/ngen_managed_assemblies.html).</span><span class="sxs-lookup"><span data-stu-id="ca17e-140">The WiX Toolkit supports queuing the generation of native images for managed assemblies during setup, as explained in this [how-to guide](https://wixtoolset.org/documentation/manual/v3/howtos/files_and_registry/ngen_managed_assemblies.html).</span></span> <span data-ttu-id="ca17e-141">Une autre solution consiste à créer une tâche d’installation personnalisée qui exécute la commande NGen. exe.</span><span class="sxs-lookup"><span data-stu-id="ca17e-141">Another alternative is to create a custom setup task that execute the NGen.exe command.</span></span>  

## <a name="verifying-that-native-images-are-being-used-for-ef"></a><span data-ttu-id="ca17e-142">Vérification de l’utilisation des images natives pour EF</span><span class="sxs-lookup"><span data-stu-id="ca17e-142">Verifying that native images are being used for EF</span></span>  

<span data-ttu-id="ca17e-143">Vous pouvez vérifier qu’une application spécifique utilise un assembly natif en recherchant les assemblys chargés portant l’extension « . ni. dll » ou « . ni. exe ».</span><span class="sxs-lookup"><span data-stu-id="ca17e-143">You can verify that a specific application is using a native assembly by looking for loaded assemblies that have the extension “.ni.dll” or “.ni.exe”.</span></span> <span data-ttu-id="ca17e-144">Par exemple, une image native de l’assembly de Runtime principal d’EF sera appelée EntityFramework. ni. dll.</span><span class="sxs-lookup"><span data-stu-id="ca17e-144">For example, a native image for the EF’s main runtime assembly will be called EntityFramework.ni.dll.</span></span> <span data-ttu-id="ca17e-145">Un moyen simple d’inspecter les assemblys .NET chargés d’un processus consiste à utiliser [Process Explorer](https://technet.microsoft.com/sysinternals/bb896653).</span><span class="sxs-lookup"><span data-stu-id="ca17e-145">An easy way to inspect the loaded .NET assemblies of a process is to use [Process Explorer](https://technet.microsoft.com/sysinternals/bb896653).</span></span>  

## <a name="other-things-to-be-aware-of"></a><span data-ttu-id="ca17e-146">Autres éléments à connaître</span><span class="sxs-lookup"><span data-stu-id="ca17e-146">Other things to be aware of</span></span>  

<span data-ttu-id="ca17e-147">La **création d’une image native d’un assembly ne doit pas être confondue avec l’inscription de l’assembly dans le [GAC (global assembly cache)](https://msdn.microsoft.com/library/yf1d93sz.aspx)** .</span><span class="sxs-lookup"><span data-stu-id="ca17e-147">**Creating a native image of an assembly should not be confused with registering the assembly in the [GAC (Global Assembly Cache)](https://msdn.microsoft.com/library/yf1d93sz.aspx)**.</span></span> <span data-ttu-id="ca17e-148">NGen. exe permet de créer des images d’assemblys qui ne se trouvent pas dans le GAC, et en fait, plusieurs applications qui utilisent une version spécifique d’EF peuvent partager la même image native.</span><span class="sxs-lookup"><span data-stu-id="ca17e-148">NGen.exe allows creating images of assemblies that are not in the GAC, and in fact, multiple applications that use a specific version of EF can share the same native image.</span></span> <span data-ttu-id="ca17e-149">Bien que Windows 8 puisse créer automatiquement des images natives pour les assemblys placés dans le GAC, l’exécution d’EF est optimisée pour être déployée en même temps que votre application. nous vous déconseillons de l’inscrire dans le GAC, car cela a un impact négatif sur la résolution de l’assembly et maintenance de vos applications entre autres aspects.</span><span class="sxs-lookup"><span data-stu-id="ca17e-149">While Windows 8 can automatically create native images for assemblies placed in the GAC, the EF runtime is optimized to be deployed alongside your application and we do not recommend registering it in the GAC as this has a negative impact on assembly resolution and servicing your applications among other aspects.</span></span>  
